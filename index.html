<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Kanit:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #fff5eb 0%, #ffe0cc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
            text-align: center;
            margin-bottom: 30px;
        }

        .header img {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
        }

        .header h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
        }

        /* Content Box */
        .content-box {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .content-box.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Report tab - no rounded corners for memo preview */
        #report.content-box {
            border-radius: 0;
            box-shadow: none;
            background: #f5f5f5;
            padding: 20px;
        }

        #memoContainer {
            background: transparent;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        #memoContainer *,
        #memoContainer *::before,
        #memoContainer *::after {
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Landing Page */
        .school-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .school-card {
            background: linear-gradient(135deg, #fff 0%, #fff5eb 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #ffe0cc;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        .school-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2);
            border-color: #ff6b35;
        }

        .school-card h3 {
            color: #ff6b35;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .school-card .count {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin: 10px 0;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffe0cc;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Sarabun', sans-serif;
            transition: all 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .number-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .student-list {
            margin-top: 20px;
            border-top: 2px solid #ffe0cc;
            padding-top: 20px;
        }

        .student-item {
            background: #fff5eb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-item .student-name-row {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: 8px;
            width: 100%;
        }

        .student-item .student-name-row select,
        .student-item .student-name-row input {
            min-width: 0;
            width: 100%;
        }

        .student-item .student-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .student-item input,
        .student-item select {
            padding: 8px;
            border: 2px solid #ffe0cc;
            border-radius: 8px;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 400;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Sarabun', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }

        .btn-secondary:hover {
            background: #ff6b35;
            color: white;
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 14px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #fff5eb 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffe0cc;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: #ff6b35;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #999;
            font-size: 14px;
        }

        /* Chart */
        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #fff5eb;
            border-radius: 15px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(255, 107, 53, 0.15);
        }

        th, td {
            padding: 13px 14px;
            text-align: left;
            border-bottom: 1px solid #ffe0cc;
        }

        th {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        thead tr th:first-child {
            border-radius: 14px 0 0 0;
        }

        thead tr th:last-child {
            border-radius: 0 14px 0 0;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr td:nth-child(n+3):nth-child(-n+8) {
            text-align: center;
            font-weight: 600;
            color: #444;
        }

        tbody tr td:nth-child(6) {
            color: #ff6b35;
            font-size: 16px;
        }

        tbody tr td:nth-child(9) {
            text-align: center;
            color: #888;
            font-size: 13px;
            white-space: nowrap;
        }

        tbody tr td:nth-child(10),
        tbody tr td:nth-child(11) {
            text-align: center;
        }

        tr:hover {
            background: #fff5eb;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff5eb;
            border-radius: 15px;
        }

        .settings-section h3 {
            color: #ff6b35;
            margin-bottom: 15px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
        }

        /* Report Text */
        .report-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            font-family: 'Sarabun', sans-serif;
            line-height: 1.8;
            white-space: pre-wrap;
            margin: 20px 0;
        }

        /* A4 Paper & Memo Layout */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 10mm 15mm 10mm 20mm;
            font-family: 'Sarabun', sans-serif;
            box-shadow: none !important;
            border-radius: 0 !important;
            outline: none !important;
            color: black;
            margin: 20px auto;
        }

        .memo-layout {
            font-family: 'Sarabun', sans-serif !important;
            position: relative;
            min-height: 297mm;
            padding: 10mm 15mm 25mm 20mm;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        /* Force remove all rounded corners and shadows in memo */
        .memo-layout *,
        .memo-layout *::before,
        .memo-layout *::after {
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        .memo-layout .garuda {
            position: absolute;
            left: 22mm;
            top: 9.3mm;
            width: 1.3cm;
            height: auto;
        }

        .memo-layout .doc-title {
            text-align: center;
            font-size: 20pt;
            font-weight: bold;
            padding-top: 5mm;
            margin-bottom: 2mm;
        }

        .memo-layout .doc-meta {
            font-size: 11pt;
            line-height: 1.4;
            margin-bottom: 1px;
            white-space: nowrap;
        }

        .memo-layout .doc-meta-row {
            display: flex;
            justify-content: flex-start;
            gap: 0;
        }

        .memo-layout .doc-meta-row .doc-ref {
            flex: 0 0 50%;
        }

        .memo-layout .doc-meta-row .doc-date {
            flex: 0 0 50%;
            text-align: left;
            padding-left: 10px;
        }

        .memo-layout .doc-line {
            border: none;
            border-bottom: 1px solid black;
            margin: 2px 0 8px 0;
        }

        .memo-layout .doc-to {
            font-size: 11pt;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .memo-layout .doc-content {
            font-size: 11pt;
            text-indent: 2.5cm;
            text-align: justify;
            line-height: 1.5;
            margin-bottom: 2px;
        }

        .memo-layout .doc-closing {
            font-size: 11pt;
            text-indent: 2.5cm;
            margin-top: 8px;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .memo-layout .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin: 4px 0;
            font-size: 10pt;
            border-radius: 0 !important;
            box-shadow: none !important;
            outline: none !important;
        }

        .memo-layout .doc-table th,
        .memo-layout .doc-table td {
            border: 1px solid black;
            padding: 2px 3px;
            text-align: center;
            vertical-align: middle;
            line-height: 1.2;
            font-size: 10pt;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        .memo-layout .doc-table th {
            background: white;
            font-weight: bold;
            font-size: 10pt;
            color: black;
        }

        .memo-layout .doc-table td.text-left {
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .memo-layout .sign-table {
            width: 100%;
            border-collapse: collapse;
            border: none !important;
            margin-top: 12px;
            border-radius: 0 !important;
            box-shadow: none !important;
            outline: none !important;
        }

        .memo-layout .sign-table td {
            border: none !important;
            vertical-align: top;
            text-align: center;
            padding: 2px 5px;
            width: 50%;
            font-size: 11pt;
            line-height: 1.3;
            white-space: nowrap;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        
        .memo-layout .name-shift-left {
            display: inline-block;
            position: relative;
            left: -10mm;
        }

        .memo-layout .checkbox-text {
            text-align: left;
            padding-left: 15px;
            margin-bottom: 1px;
            font-size: 11pt;
        }

        .memo-layout .footer-system {
            position: absolute;
            bottom: 10mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 10pt;
            color: #666;
            font-style: italic;
        }

        /* Detail Cards (mobile view) */
        .detail-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(255, 107, 53, 0.12);
            margin-top: 20px;
        }

        .detail-table-wrapper table {
            min-width: 900px;
            box-shadow: none;
            margin-top: 0;
        }

        .detail-cards {
            display: none; /*Ïà®‡∏Å‡πá‡∏à‡∏≤‡∏Å desktop */
        }

        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #ff6b35;
        }

        .detail-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .detail-card .card-school-name {
            font-size: 17px;
            font-weight: 700;
            color: #ff6b35;
        }

        .detail-card .card-date {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
        }

        .detail-card .card-teacher {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .detail-card .card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .detail-card .card-stat-item {
            background: #fff5eb;
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
        }

        .detail-card .card-stat-item .stat-label {
            font-size: 11px;
            color: #888;
            display: block;
            margin-bottom: 2px;
        }

        .detail-card .card-stat-item .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .detail-card .card-stat-item.highlight .stat-value {
            color: #ff6b35;
        }

        .detail-card .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .detail-card .card-actions button {
            flex: 1;
            min-width: 0;
            padding: 10px 8px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
        }

        .detail-card .btn-card-copy {
            background: #28a745;
            color: white;
        }

        .detail-card .btn-card-edit {
            background: #007bff;
            color: white;
        }

        .detail-card .btn-card-delete {
            background: #dc3545;
            color: white;
        }

        @media print {
            @page {
                size: A4;
                margin: 0mm;
            }

            * {
                visibility: hidden;
            }
            
            .a4-paper,
            .a4-paper * {
                visibility: visible;
            }
            
            .a4-paper {
                position: absolute;
                left: 0;
                top: 0;
                margin: 0 !important;
                padding: 10mm 15mm 10mm 20mm !important;
                width: 210mm !important;
                min-height: 297mm !important;
                box-shadow: none !important;
                border: none !important;
                background: white !important;
            }
        }

        /* Responsive Design for Mobile and Tablet */
        @media screen and (max-width: 1024px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .header p {
                font-size: 14px;
            }

            .header img {
                width: 60px;
                height: 60px;
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                flex-shrink: 0;
                padding: 10px 15px;
                font-size: 14px;
                white-space: nowrap;
            }

            .content-box {
                padding: 20px 15px;
            }

            .school-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .school-card h3 {
                font-size: 16px;
            }

            .school-card .count {
                font-size: 28px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-card .value {
                font-size: 28px;
            }

            .number-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            #percentageDisplay > div {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            #percentageDisplay .value {
                font-size: 36px !important;
            }

            .chart-container {
                padding: 15px;
            }

            table {
                font-size: 13px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            th, td {
                padding: 8px 6px;
            }

            .a4-paper {
                width: 100%;
                max-width: 100%;
                padding: 5mm 8mm;
                min-height: auto;
            }

            .memo-layout {
                padding: 5mm 8mm;
                font-size: 9pt;
            }

            .memo-layout .doc-title {
                font-size: 16pt;
            }

            .memo-layout .doc-meta {
                font-size: 9pt;
            }

            .memo-layout .doc-table {
                font-size: 8pt;
            }

            .memo-layout .doc-table th,
            .memo-layout .doc-table td {
                font-size: 8pt;
                padding: 2px;
            }

            .settings-section {
                padding: 15px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10% auto;
            }

            .modal-header h3 {
                font-size: 20px;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .btn-small {
                padding: 6px 15px;
                font-size: 12px;
            }
        }

        @media screen and (max-width: 768px) {
            #report.content-box {
                border-radius: 0;
                box-shadow: none;
                background: #f5f5f5;
                padding: 10px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 13px;
            }

            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }

            .school-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Student item: select full width, name row 2 cols */
            .student-item .student-name-row {
                grid-template-columns: 1fr 1fr;
            }

            .student-item .student-name-row select {
                grid-column: 1 / -1;
            }

            .form-group label {
                font-size: 14px;
            }

            .form-group select,
            .form-group input,
            .form-group textarea {
                font-size: 16px; /* iOS 16px min to avoid zoom */
                padding: 10px;
            }

            .student-item input,
            .student-item select {
                font-size: 16px;
            }

            .checkbox-group {
                gap: 15px;
            }

            .modal-content {
                padding: 15px;
                margin: 5% auto;
            }

            #modalReportText,
            .report-text {
                font-size: 13px;
                padding: 15px;
            }

            #percentageDisplay {
                font-size: 14px !important;
            }

            #percentageDisplay .value {
                font-size: 32px !important;
            }

            #percentageDisplay > div > div:last-child > div:last-child {
                position: static !important;
                margin-top: 10px;
                display: inline-block;
            }

            /* Detail:Ïà® table, ‡πÅ‡∏™‡∏î‡∏á cards */
            .detail-table-wrapper {
                display: none;
            }

            .detail-cards {
                display: block;
            }

            /* A4 Paper: scale to fit mobile viewport */
            #memoContainer {
                width: 100%;
                overflow: hidden;
                background: transparent;
            }

            .a4-paper {
                width: 210mm;
                min-height: auto;
                margin: 0;
                transform-origin: top left;
                /* scale ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì dynamically ‡πÇ‡∏î‡∏¢ JS */
            }
        }

        @media screen and (max-width: 480px) {
            #report.content-box {
                border-radius: 0;
                box-shadow: none;
                padding: 10px 5px;
            }

            .header {
                padding: 15px 10px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header img {
                width: 50px;
                height: 50px;
            }

            .content-box {
                padding: 15px 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card .value {
                font-size: 24px;
            }

            .btn {
                padding: 8px 15px;
                font-size: 13px;
            }

            .tab {
                font-size: 12px;
                padding: 8px 10px;
            }

            #percentageDisplay > div > div:last-child > div:last-child {
                font-size: 18px !important;
                padding: 8px 15px !important;
            }
        }

        /* Utility */
        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ffe0cc;
        }

        .modal-header h3 {
            color: #ff6b35;
            font-size: 24px;
            margin: 0;
        }

        .close {
            color: #999;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }

        .close:hover {
            color: #ff6b35;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" alt="‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤" crossorigin="anonymous">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <p>‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥<br>‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('landing')">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
            <button class="tab" onclick="showTab('submit')">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <button class="tab" onclick="showTab('stats')">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
            <button class="tab" onclick="showTab('report')">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            <button class="tab" onclick="showSettingsTab()" style="font-size: 20px; padding: 12px 20px;">‚öôÔ∏è</button>
        </div>

        <!-- Landing Page -->
        <div id="landing" class="content-box active">
            <h2 style="color: #ff6b35; margin-bottom: 20px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß</h2>
            <div class="school-grid" id="schoolGrid">
                <!-- Schools will be loaded here -->
            </div>
        </div>

        <!-- Submit Form -->
        <div id="submit" class="content-box">
            <h2 style="color: #ff6b35; margin-bottom: 20px;">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            
            <div class="form-group">
                <label>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <select id="schoolSelect">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                <select id="teacherSelect">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <input type="number" id="totalStudentsInSchool" min="0" value="0" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
            </div>

            <div class="form-group">
                <label style="font-size: 18px; font-weight: 700; color: #ff6b35; display: flex; align-items: center; gap: 8px;">
                    üìù ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                    <span style="font-size: 13px; font-weight: 400; color: #fff; background: #ff6b35; padding: 3px 10px; border-radius: 20px; white-space: nowrap;">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®</span>
                </label>
                <div class="number-inputs">
                    <div>
                        <label style="font-size: 14px; color: #666;">üë¶ ‡∏ä‡∏≤‡∏¢</label>
                        <input type="number" id="maleCount" min="0" value="0" oninput="generateStudentForms()">
                    </div>
                    <div>
                        <label style="font-size: 14px; color: #666;">üëß ‡∏´‡∏ç‡∏¥‡∏á</label>
                        <input type="number" id="femaleCount" min="0" value="0" oninput="generateStudentForms()">
                    </div>
                    <div>
                        <label style="font-size: 14px; color: #666;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <input type="number" id="totalCount" readonly style="background: #f0f0f0; font-weight: 700; color: #ff6b35;">
                    </div>
                </div>
            </div>

            <div class="student-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #ff6b35;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <button class="btn btn-secondary btn-small" onclick="addStudent()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </div>
                <div id="studentList">
                    <!-- Students will be added here -->
                </div>
            </div>

            <div class="text-center mt-20">
                <button class="btn btn-primary" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>

        <!-- Statistics -->
        <div id="stats" class="content-box">
            <h2 style="color: #ff6b35; margin-bottom: 20px;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 600; margin-right: 10px;">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á:</label>
                <select id="filterSchool" onchange="filterStatistics()" style="padding: 8px 15px; border: 2px solid #ffe0cc; border-radius: 8px; font-size: 16px; font-family: 'Sarabun', sans-serif;">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
            </div>

            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be loaded here -->
            </div>

            <div class="chart-container">
                <h3 style="color: #ff6b35; margin-bottom: 15px;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <div id="percentageDisplay" style="text-align: center; padding: 30px; background: white; border-radius: 10px; margin-bottom: 20px;">
                    <!-- Percentage will be displayed here -->
                </div>
            </div>

            <div class="chart-container">
                <h3 style="color: #ff6b35; margin-bottom: 15px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <canvas id="schoolChart" style="max-height: 400px;"></canvas>
            </div>

            <h3 style="color: #ff6b35; margin-bottom: 15px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <!-- Table view ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö desktop -->
            <div class="detail-table-wrapper">
                <table id="detailTable">
                    <thead>
                        <tr>
                            <th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            <th>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                            <th>‡∏ô‡∏£.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                            <th>‡∏ä‡∏≤‡∏¢</th>
                            <th>‡∏´‡∏ç‡∏¥‡∏á</th>
                            <th>‡∏£‡∏ß‡∏°</th>
                            <th>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                            <th>‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ<br>(‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                    </tbody>
                </table>
            </div>
            <!-- Card view ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile -->
            <div id="detailCards" class="detail-cards"></div>

            <div class="text-center mt-20">
                <button class="btn btn-success" onclick="copyReportText()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå</button>
            </div>

            <div id="reportTextContainer" class="report-text hidden"></div>
        </div>

        <!-- Modal -->
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå</h3>
                    <span class="close" onclick="closeReportModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="modalReportText" class="report-text" style="display: block; max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeReportModal()">‡∏õ‡∏¥‡∏î</button>
                    <button class="btn btn-success" onclick="copyFromModal()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Report -->
        <div id="report" class="content-box">
            <h2 style="color: #ff6b35; margin-bottom: 20px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤</h2>
            
            <div class="text-center mb-20">
                <button class="btn btn-primary" onclick="generateMemoReport()">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                <button class="btn btn-secondary" onclick="printMemo()" style="margin-left: 10px;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            </div>

            <div id="memoContainer"></div>
        </div>

        <!-- Settings -->
        <div id="settings" class="content-box">
            <h2 style="color: #ff6b35; margin-bottom: 20px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <div class="settings-section">
                <h3>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏à‡∏≤‡∏Å Excel ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠ 1 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</p>
                <div class="form-group">
                    <textarea id="newSchool" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ)" rows="3" style="width: 100%; padding: 12px; border: 2px solid #ffe0cc; border-radius: 10px; font-size: 16px; font-family: 'Sarabun', sans-serif; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addSchool()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <div id="schoolList" class="mt-20"></div>
            </div>

            <div class="settings-section">
                <h3>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏à‡∏≤‡∏Å Excel ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠ 1 ‡∏Ñ‡∏£‡∏π)</p>
                <div class="form-group">
                    <textarea id="newTeacher" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Ñ‡∏£‡∏π (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ)" rows="3" style="width: 100%; padding: 12px; border: 2px solid #ffe0cc; border-radius: 10px; font-size: 16px; font-family: 'Sarabun', sans-serif; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addTeacher()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</button>
                <div id="teacherList" class="mt-20"></div>
            </div>

            <div class="settings-section">
                <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤</h3>
                <div class="form-group">
                    <label>‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</label>
                    <input type="text" id="academicHead" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>
                <div class="form-group">
                    <label>‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="deputyDirector" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>
                <div class="form-group">
                    <label>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="director" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCW0myweqSL3hEtCPTfzzsEeyO1lnzk-sI",
            authDomain: "nanaewktw.firebaseapp.com",
            projectId: "nanaewktw",
            storageBucket: "nanaewktw.firebasestorage.app",
            messagingSenderId: "1028815149041",
            appId: "1:1028815149041:web:11429d3b7addcb78f9d650"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make db and functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.updateDoc = updateDoc;
        window.query = query;
        window.orderBy = orderBy;

        // Initialize app
        loadSettings();
        loadSchools();
        loadTeachers();
        
        // Load data once after Firebase is ready
        setTimeout(() => {
            loadData();
        }, 800);
        
        // Add one student field by default when switching to submit tab
        window.addEventListener('DOMContentLoaded', () => {
            // We'll add the student when user clicks submit tab
        });
    </script>

    <script>
        let studentCounter = 0;
        
        // Add initial student field
        function initializeSubmitForm() {
            const studentList = document.getElementById('studentList');
            if (studentList.children.length === 0) {
                addStudent();
            }
        }

        function showTab(tabName) {
            // Hide all content boxes
            document.querySelectorAll('.content-box').forEach(box => {
                box.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content box
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            // Initialize submit form when opening submit tab
            if (tabName === 'submit') {
                initializeSubmitForm();
            }
        }

        function showSettingsTab() {
            Swal.fire({
                title: 'üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
                input: 'password',
                inputAttributes: { autocomplete: 'current-password', placeholder: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' },
                showCancelButton: true,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤',
                confirmButtonColor: '#ff6b35',
                cancelButtonColor: '#aaa',
                customClass: { input: 'swal-input-custom' }
            }).then((result) => {
                if (result.isDismissed) return;
                if (result.value === '1234') {
                    showTab('settings');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        confirmButtonColor: '#ff6b35',
                        timer: 2000,
                        timerProgressBar: true
                    });
                }
            });
        }

        function updateTotal() {
            const male = parseInt(document.getElementById('maleCount').value) || 0;
            const female = parseInt(document.getElementById('femaleCount').value) || 0;
            document.getElementById('totalCount').value = male + female;
        }

        function generateStudentForms() {
            updateTotal();

            const male = parseInt(document.getElementById('maleCount').value) || 0;
            const female = parseInt(document.getElementById('femaleCount').value) || 0;
            const total = male + female;

            // ‡∏ñ‡πâ‡∏≤ total = 0 ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå
            if (total === 0) {
                document.getElementById('studentList').innerHTML = '';
                studentCounter = 0;
                return;
            }

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            const existingData = [];
            document.querySelectorAll('.student-item').forEach(item => {
                existingData.push({
                    prefix: item.querySelector('select').value,
                    firstName: item.querySelectorAll('input[type="text"]')[0].value,
                    lastName: item.querySelectorAll('input[type="text"]')[1].value,
                    hasWritten: item.querySelector('.checkbox-written').checked,
                    hasReceived: item.querySelector('.checkbox-received').checked
                });
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á target list: ‡∏ä‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏ç‡∏¥‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏° default prefix
            const targetPrefixes = [];
            for (let i = 0; i < male; i++) targetPrefixes.push('‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢');
            for (let i = 0; i < female; i++) targetPrefixes.push('‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á');

            // ‡∏•‡πâ‡∏≤‡∏á + rebuild ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö existing data ‡πÑ‡∏ß‡πâ
            document.getElementById('studentList').innerHTML = '';
            studentCounter = 0;

            targetPrefixes.forEach((defaultPrefix, index) => {
                studentCounter++;
                const existing = existingData[index]; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                const studentList = document.getElementById('studentList');
                const div = document.createElement('div');
                div.className = 'student-item';
                div.id = `student-${studentCounter}`;

                const prefix = existing && existing.firstName ? existing.prefix : defaultPrefix;
                const firstName = existing ? existing.firstName : '';
                const lastName = existing ? existing.lastName : '';
                const hasWritten = existing ? existing.hasWritten : false;
                const hasReceived = existing ? existing.hasReceived : false;

                div.innerHTML = `
                    <div class="student-name-row">
                        <select>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢" ${prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢' ? 'selected' : ''}>‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á" ${prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á' ? 'selected' : ''}>‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏¢" ${prefix === '‡∏ô‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" ${prefix === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß' ? 'selected' : ''}>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                        <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${firstName}" required>
                        <input type="text" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value="${lastName}" required>
                    </div>
                    <div class="student-bottom-row">
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" class="checkbox-written" ${hasWritten ? 'checked' : ''}>
                                ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß
                            </label>
                            <label>
                                <input type="checkbox" class="checkbox-received" ${hasReceived ? 'checked' : ''}>
                                ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
                            </label>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="removeStudent(${studentCounter})">‡∏•‡∏ö</button>
                    </div>
                `;
                studentList.appendChild(div);
            });
        }

        function addStudent() {
            studentCounter++;
            const studentList = document.getElementById('studentList');
            const div = document.createElement('div');
            div.className = 'student-item';
            div.id = `student-${studentCounter}`;
            div.innerHTML = `
                <div class="student-name-row">
                    <select>
                        <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                        <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                        <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                        <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                    </select>
                    <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required>
                    <input type="text" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                </div>
                <div class="student-bottom-row">
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" class="checkbox-written">
                            ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß
                        </label>
                        <label>
                            <input type="checkbox" class="checkbox-received">
                            ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
                        </label>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeStudent(${studentCounter})">‡∏•‡∏ö</button>
                </div>
            `;
            studentList.appendChild(div);
        }

        function removeStudent(id) {
            document.getElementById(`student-${id}`).remove();
        }

        async function deleteRecord(id) {
            const { isConfirmed } = await Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ',
                showCancelButton: true,
                confirmButtonText: 'üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#aaa'
            });

            if (isConfirmed) {
                try {
                    await window.deleteDoc(window.doc(window.db, 'registrations', id));
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#ff6b35', timer: 1500, timerProgressBar: true, showConfirmButton: false });
                    loadData();
                } catch (error) {
                    console.error('Error deleting record:', error);
                    Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', confirmButtonColor: '#ff6b35' });
                }
            }
        }

        async function editRecord(id) {
            try {
                // Find the record in window.allRegistrationData
                const record = window.allRegistrationData.find(item => item.id === id);
                if (!record) {
                    Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', confirmButtonColor: '#ff6b35' });
                    return;
                }

                // Set current editing ID
                window.currentEditingId = id;

                // Fill form with data
                document.getElementById('schoolSelect').value = record.school;
                document.getElementById('teacherSelect').value = record.teacher;
                document.getElementById('totalStudentsInSchool').value = record.totalStudentsInSchool || 0;
                document.getElementById('maleCount').value = record.male || 0;
                document.getElementById('femaleCount').value = record.female || 0;
                updateTotal();

                // Clear and add students
                document.getElementById('studentList').innerHTML = '';
                studentCounter = 0;
                
                if (record.students && record.students.length > 0) {
                    record.students.forEach(student => {
                        studentCounter++;
                        const studentList = document.getElementById('studentList');
                        const div = document.createElement('div');
                        div.className = 'student-item';
                        div.id = `student-${studentCounter}`;
                        div.innerHTML = `
                            <div class="student-name-row">
                                <select>
                                    <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢" ${student.prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢' ? 'selected' : ''}>‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                                    <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á" ${student.prefix === '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á' ? 'selected' : ''}>‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                                    <option value="‡∏ô‡∏≤‡∏¢" ${student.prefix === '‡∏ô‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ô‡∏≤‡∏¢</option>
                                    <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" ${student.prefix === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß' ? 'selected' : ''}>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                                </select>
                                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${student.firstName}" required>
                                <input type="text" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value="${student.lastName}" required>
                            </div>
                            <div class="student-bottom-row">
                                <div class="checkbox-group">
                                    <label>
                                        <input type="checkbox" class="checkbox-written" ${student.hasWritten ? 'checked' : ''}>
                                        ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß
                                    </label>
                                    <label>
                                        <input type="checkbox" class="checkbox-received" ${student.hasReceived ? 'checked' : ''}>
                                        ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
                                    </label>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="removeStudent(${studentCounter})">‡∏•‡∏ö</button>
                            </div>
                        `;
                        studentList.appendChild(div);
                    });
                } else {
                    addStudent();
                }

                // Change to submit tab
                showTab('submit');
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.querySelectorAll('.tab')[0].classList.remove('active');

                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
            } catch (error) {
                console.error('Error editing record:', error);
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', confirmButtonColor: '#ff6b35' });
            }
        }

        async function saveData() {
            const school = document.getElementById('schoolSelect').value;
            const teacher = document.getElementById('teacherSelect').value;
            const male = parseInt(document.getElementById('maleCount').value) || 0;
            const female = parseInt(document.getElementById('femaleCount').value) || 0;
            const totalStudentsInSchool = parseInt(document.getElementById('totalStudentsInSchool').value) || 0;

            if (!school || !teacher) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    confirmButtonColor: '#ff6b35',
                    timer: 2500,
                    timerProgressBar: true
                });
                return;
            }

            // Get student data
            const students = [];
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                const prefix = item.querySelector('select').value;
                const firstName = item.querySelectorAll('input[type="text"]')[0].value;
                const lastName = item.querySelectorAll('input[type="text"]')[1].value;
                const hasWritten = item.querySelector('.checkbox-written').checked;
                const hasReceived = item.querySelector('.checkbox-received').checked;

                if (firstName && lastName) {
                    students.push({
                        prefix,
                        firstName,
                        lastName,
                        hasWritten,
                        hasReceived
                    });
                }
            });

            const data = {
                school,
                teacher,
                male,
                female,
                total: male + female,
                totalStudentsInSchool,
                students,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('th-TH')
            };

            try {
                // Check if editing existing record
                if (window.currentEditingId) {
                    await window.updateDoc(window.doc(window.db, 'registrations', window.currentEditingId), data);
                    showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    window.currentEditingId = null;
                    
                    // Reset form
                    document.getElementById('maleCount').value = 0;
                    document.getElementById('femaleCount').value = 0;
                    document.getElementById('totalCount').value = 0;
                    document.getElementById('totalStudentsInSchool').value = 0;
                    document.getElementById('studentList').innerHTML = '';
                    studentCounter = 0;
                    
                    // Add one student field again
                    addStudent();

                    // Reload data
                    await loadData();
                    
                    // Switch to stats tab
                    document.querySelectorAll('.content-box').forEach(box => box.classList.remove('active'));
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.getElementById('stats').classList.add('active');
                    document.querySelectorAll('.tab')[2].classList.add('active');
                } else {
                    await window.addDoc(window.collection(window.db, 'registrations'), data);
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    
                    // Reset form
                    document.getElementById('maleCount').value = 0;
                    document.getElementById('femaleCount').value = 0;
                    document.getElementById('totalCount').value = 0;
                    document.getElementById('totalStudentsInSchool').value = 0;
                    document.getElementById('studentList').innerHTML = '';
                    studentCounter = 0;
                    
                    // Add one student field again
                    addStudent();

                    // Reload data
                    loadData();
                }
            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', confirmButtonColor: '#ff6b35' });
            }
        }

        async function loadData() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'registrations'));
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });

                updateStatistics(data);
                updateDetailTable(data);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function updateStatistics(data) {
            let totalStudents = 0;
            let totalMale = 0;
            let totalFemale = 0;
            let totalWritten = 0;
            let totalReceived = 0;
            let totalStudentsInAllSchools = 0;
            const schoolCounts = {};

            data.forEach(item => {
                totalStudents += item.total || 0;
                totalMale += item.male || 0;
                totalFemale += item.female || 0;
                totalStudentsInAllSchools += item.totalStudentsInSchool || 0;

                if (item.students) {
                    item.students.forEach(student => {
                        if (student.hasWritten) totalWritten++;
                        if (student.hasReceived) totalReceived++;
                    });
                }

                if (!schoolCounts[item.school]) {
                    schoolCounts[item.school] = 0;
                }
                schoolCounts[item.school] += item.total || 0;
            });

            // Calculate percentage
            const percentage = totalStudentsInAllSchools > 0 
                ? ((totalStudents / totalStudentsInAllSchools) * 100).toFixed(2)
                : 0;

            // Update stats grid
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="value">${totalStudentsInAllSchools}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                    <div class="value">${totalStudents}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏≤‡∏¢</h3>
                    <div class="value">${totalMale}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏ç‡∏¥‡∏á</h3>
                    <div class="value">${totalFemale}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                    <div class="value">${totalWritten}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ<br><span style="font-size:13px;font-weight:400;color:#888;">(‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)</span></h3>
                    <div class="value">${totalReceived}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
            `;

            // Update percentage display
            const percentageDisplay = document.getElementById('percentageDisplay');
            percentageDisplay.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center;">
                    <div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div style="font-size: 48px; font-weight: 700; color: #333;">${totalStudentsInAllSchools}</div>
                        <div style="font-size: 16px; color: #999;">‡∏Ñ‡∏ô</div>
                    </div>
                    <div style="position: relative;">
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
                        <div style="font-size: 48px; font-weight: 700; color: #ff6b35;">${totalStudents}</div>
                        <div style="font-size: 16px; color: #999;">‡∏Ñ‡∏ô</div>
                        <div style="position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); color: white; padding: 10px 20px; border-radius: 50px; font-size: 24px; font-weight: 700; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);">
                            ${percentage}%
                        </div>
                    </div>
                </div>
            `;

            // Update filter dropdown
            const filterSchool = document.getElementById('filterSchool');
            const currentValue = filterSchool.value;
            filterSchool.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            Object.keys(schoolCounts).sort().forEach(school => {
                const option = document.createElement('option');
                option.value = school;
                option.textContent = school;
                filterSchool.appendChild(option);
            });
            filterSchool.value = currentValue;

            // Update school grid in landing page - Show ALL schools from settings
            await updateSchoolGrid(schoolCounts);
            
            // Update chart
            updateChart(schoolCounts);
            
            // Store data globally for filtering
            window.allRegistrationData = data;
        }

        function updateChart(schoolCounts) {
            const ctx = document.getElementById('schoolChart');
            if (!ctx) return;

            // Destroy existing chart if exists
            if (window.schoolChartInstance) {
                window.schoolChartInstance.destroy();
            }

            const schools = Object.keys(schoolCounts).sort();
            const counts = schools.map(school => schoolCounts[school]);

            window.schoolChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: schools,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£',
                        data: counts,
                        backgroundColor: 'rgba(255, 107, 53, 0.7)',
                        borderColor: 'rgba(255, 107, 53, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Sarabun',
                                    size: 14
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                family: 'Sarabun',
                                size: 14
                            },
                            bodyFont: {
                                family: 'Sarabun',
                                size: 13
                            },
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    family: 'Sarabun',
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(255, 107, 53, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Sarabun',
                                    size: 12
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        async function updateSchoolGrid(schoolCounts) {
            const schoolGrid = document.getElementById('schoolGrid');
            schoolGrid.innerHTML = '';
            
            // Get all schools from settings
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'schools'));
                const allSchools = [];
                querySnapshot.forEach((doc) => {
                    allSchools.push(doc.data().name);
                });
                
                // Sort and display all schools
                allSchools.sort().forEach(school => {
                    const count = schoolCounts[school] || 0;
                    const card = document.createElement('div');
                    card.className = 'school-card';
                    card.onclick = () => selectSchool(school);
                    card.innerHTML = `
                        <h3>${school}</h3>
                        <div class="count">${count}</div>
                        <div class="label">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
                    `;
                    schoolGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading schools for grid:', error);
            }
        }

        function updateDetailTable(data) {
            const tbody = document.getElementById('detailTableBody');
            tbody.innerHTML = '';

            const cardsContainer = document.getElementById('detailCards');
            cardsContainer.innerHTML = '';

            data.forEach(item => {
                const written = item.students ? item.students.filter(s => s.hasWritten).length : 0;
                const received = item.students ? item.students.filter(s => s.hasReceived).length : 0;

                // --- Table Row (desktop) ---
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.school}</td>
                    <td>${item.teacher}</td>
                    <td>${item.totalStudentsInSchool || 0}</td>
                    <td>${item.male || 0}</td>
                    <td>${item.female || 0}</td>
                    <td><strong>${item.total || 0}</strong></td>
                    <td>${written}</td>
                    <td>${received}</td>
                    <td>${item.date}</td>
                    <td style="padding: 8px;">
                        <button class="btn btn-success btn-small" onclick="copySchoolReport('${item.id}')" style="width: 100%; font-size: 13px;">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                    </td>
                    <td style="padding: 8px;">
                        <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                            <button onclick="editRecord('${item.id}')" style="background: #007bff; color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,123,255,0.3);" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 10px rgba(0,123,255,0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(0,123,255,0.3)';" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                            <button onclick="deleteRecord('${item.id}')" style="background: #dc3545; color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 2px 5px rgba(220,53,69,0.3);" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 10px rgba(220,53,69,0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(220,53,69,0.3)';" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);

                // --- Card (mobile) ---
                const card = document.createElement('div');
                card.className = 'detail-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-school-name">üè´ ${item.school}</div>
                        <div class="card-date">${item.date}</div>
                    </div>
                    <div class="card-teacher">üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${item.teacher}</div>
                    <div class="card-stats">
                        <div class="card-stat-item">
                            <span class="stat-label">‡∏ô‡∏£.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <span class="stat-value">${item.totalStudentsInSchool || 0}</span>
                        </div>
                        <div class="card-stat-item">
                            <span class="stat-label">‡∏ä‡∏≤‡∏¢</span>
                            <span class="stat-value">${item.male || 0}</span>
                        </div>
                        <div class="card-stat-item">
                            <span class="stat-label">‡∏´‡∏ç‡∏¥‡∏á</span>
                            <span class="stat-value">${item.female || 0}</span>
                        </div>
                        <div class="card-stat-item highlight">
                            <span class="stat-label">‡∏£‡∏ß‡∏°</span>
                            <span class="stat-value">${item.total || 0}</span>
                        </div>
                        <div class="card-stat-item">
                            <span class="stat-label">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                            <span class="stat-value">${written}</span>
                        </div>
                        <div class="card-stat-item">
                            <span class="stat-label">‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ<br>(‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠)</span>
                            <span class="stat-value">${received}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-card-copy" onclick="copySchoolReport('${item.id}')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                        <button class="btn-card-edit" onclick="editRecord('${item.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn-card-delete" onclick="deleteRecord('${item.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
        }

        async function copySchoolReport(id) {
            try {
                // Find the record
                const record = window.allRegistrationData.find(item => item.id === id);
                if (!record) {
                    Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ', confirmButtonColor: '#ff6b35' });
                    return;
                }

                const written = record.students ? record.students.filter(s => s.hasWritten).length : 0;
                const received = record.students ? record.students.filter(s => s.hasReceived).length : 0;

                let reportText = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}

üè´ ${record.school}
üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${record.teacher}

‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
‚Ä¢ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${record.totalStudentsInSchool || 0} ‡∏Ñ‡∏ô
‚Ä¢ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${record.total || 0} ‡∏Ñ‡∏ô
  - ‡∏ä‡∏≤‡∏¢: ${record.male || 0} ‡∏Ñ‡∏ô
  - ‡∏´‡∏ç‡∏¥‡∏á: ${record.female || 0} ‡∏Ñ‡∏ô
‚Ä¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß: ${written} ‡∏Ñ‡∏ô
‚Ä¢ ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á: ${received} ‡∏Ñ‡∏ô`;

                if (record.students && record.students.length > 0) {
                    reportText += `

üìù ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${record.students.length} ‡∏Ñ‡∏ô)`;
                    record.students.forEach((student, index) => {
                        const status = [];
                        if (student.hasWritten) status.push('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß');
                        if (student.hasReceived) status.push('‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
                        const statusText = status.length > 0 ? ` (${status.join(', ')})` : '';
                        reportText += `
${index + 1}. ${student.prefix}${student.firstName} ${student.lastName}${statusText}`;
                    });
                }

                reportText += `

üìù ‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤`;

                // Store report text globally
                window.currentReportText = reportText;

                // Show modal
                document.getElementById('modalReportText').textContent = reportText;
                document.getElementById('reportModal').style.display = 'block';
            } catch (error) {
                console.error('Error copying school report:', error);
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', confirmButtonColor: '#ff6b35' });
            }
        }

        function filterStatistics() {
            const selectedSchool = document.getElementById('filterSchool').value;
            let filteredData = window.allRegistrationData || [];

            if (selectedSchool !== 'all') {
                filteredData = filteredData.filter(item => item.school === selectedSchool);
            }

            // Recalculate statistics with filtered data
            let totalStudents = 0;
            let totalMale = 0;
            let totalFemale = 0;
            let totalWritten = 0;
            let totalReceived = 0;
            let totalStudentsInAllSchools = 0;
            const schoolCounts = {};

            filteredData.forEach(item => {
                totalStudents += item.total || 0;
                totalMale += item.male || 0;
                totalFemale += item.female || 0;
                totalStudentsInAllSchools += item.totalStudentsInSchool || 0;

                if (item.students) {
                    item.students.forEach(student => {
                        if (student.hasWritten) totalWritten++;
                        if (student.hasReceived) totalReceived++;
                    });
                }

                if (!schoolCounts[item.school]) {
                    schoolCounts[item.school] = 0;
                }
                schoolCounts[item.school] += item.total || 0;
            });

            // Calculate percentage
            const percentage = totalStudentsInAllSchools > 0 
                ? ((totalStudents / totalStudentsInAllSchools) * 100).toFixed(2)
                : 0;

            // Update stats grid
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="value">${totalStudentsInAllSchools}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                    <div class="value">${totalStudents}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏≤‡∏¢</h3>
                    <div class="value">${totalMale}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏ç‡∏¥‡∏á</h3>
                    <div class="value">${totalFemale}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                    <div class="value">${totalWritten}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ<br><span style="font-size:13px;font-weight:400;color:#888;">(‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)</span></h3>
                    <div class="value">${totalReceived}</div>
                    <div class="label">‡∏Ñ‡∏ô</div>
                </div>
            `;

            // Update percentage display
            const percentageDisplay = document.getElementById('percentageDisplay');
            percentageDisplay.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center;">
                    <div>
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div style="font-size: 48px; font-weight: 700; color: #333;">${totalStudentsInAllSchools}</div>
                        <div style="font-size: 16px; color: #999;">‡∏Ñ‡∏ô</div>
                    </div>
                    <div style="position: relative;">
                        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
                        <div style="font-size: 48px; font-weight: 700; color: #ff6b35;">${totalStudents}</div>
                        <div style="font-size: 16px; color: #999;">‡∏Ñ‡∏ô</div>
                        <div style="position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); color: white; padding: 10px 20px; border-radius: 50px; font-size: 24px; font-weight: 700; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);">
                            ${percentage}%
                        </div>
                    </div>
                </div>
            `;

            // Update chart
            updateChart(schoolCounts);

            // Update detail table using the function
            updateDetailTable(filteredData);
        }

        function selectSchool(school) {
            document.getElementById('schoolSelect').value = school;
            showTab('submit');
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.querySelectorAll('.tab')[0].classList.remove('active');
            initializeSubmitForm();
        }

        async function copyReportText() {
            const querySnapshot = await window.getDocs(window.collection(window.db, 'registrations'));
            const data = [];
            querySnapshot.forEach((doc) => {
                data.push(doc.data());
            });

            let totalStudents = 0;
            let totalMale = 0;
            let totalFemale = 0;
            let totalWritten = 0;
            let totalReceived = 0;
            const schoolData = {};

            data.forEach(item => {
                totalStudents += item.total || 0;
                totalMale += item.male || 0;
                totalFemale += item.female || 0;

                if (!schoolData[item.school]) {
                    schoolData[item.school] = { total: 0, male: 0, female: 0, written: 0, received: 0 };
                }
                schoolData[item.school].total += item.total || 0;
                schoolData[item.school].male += item.male || 0;
                schoolData[item.school].female += item.female || 0;

                if (item.students) {
                    item.students.forEach(student => {
                        if (student.hasWritten) {
                            totalWritten++;
                            schoolData[item.school].written++;
                        }
                        if (student.hasReceived) {
                            totalReceived++;
                            schoolData[item.school].received++;
                        }
                    });
                }
            });

            let reportText = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}

‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
‚Ä¢ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${totalStudents} ‡∏Ñ‡∏ô
‚Ä¢ ‡∏ä‡∏≤‡∏¢: ${totalMale} ‡∏Ñ‡∏ô
‚Ä¢ ‡∏´‡∏ç‡∏¥‡∏á: ${totalFemale} ‡∏Ñ‡∏ô
‚Ä¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß: ${totalWritten} ‡∏Ñ‡∏ô
‚Ä¢ ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á: ${totalReceived} ‡∏Ñ‡∏ô

üìç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
`;

            Object.keys(schoolData).sort().forEach(school => {
                const sd = schoolData[school];
                reportText += `
${school}
‚Ä¢ ‡∏£‡∏ß‡∏° ${sd.total} ‡∏Ñ‡∏ô (‡∏ä‡∏≤‡∏¢ ${sd.male} ‡∏´‡∏ç‡∏¥‡∏á ${sd.female})
‚Ä¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ${sd.written} ‡∏Ñ‡∏ô, ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ${sd.received} ‡∏Ñ‡∏ô
`;
            });

            reportText += `
üìù ‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤`;

            // Store report text globally
            window.currentReportText = reportText;

            // Show modal
            document.getElementById('modalReportText').textContent = reportText;
            document.getElementById('reportModal').style.display = 'block';
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        function copyFromModal() {
            const reportText = window.currentReportText;
            navigator.clipboard.writeText(reportText).then(() => {
                showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeReportModal();
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target == modal) {
                closeReportModal();
            }
        }

        async function loadSchools() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'schools'));
                const schools = [];
                querySnapshot.forEach((doc) => {
                    schools.push({ id: doc.id, name: doc.data().name });
                });

                // Update school select
                const schoolSelect = document.getElementById('schoolSelect');
                schoolSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>';
                schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.name;
                    option.textContent = school.name;
                    schoolSelect.appendChild(option);
                });

                // Update school list in settings
                const schoolList = document.getElementById('schoolList');
                schoolList.innerHTML = '';
                schools.forEach(school => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span>${school.name}</span>
                        <button class="btn btn-danger btn-small" onclick="deleteSchool('${school.id}')">‡∏•‡∏ö</button>
                    `;
                    schoolList.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading schools:', error);
            }
        }

        async function addSchool() {
            const input = document.getElementById('newSchool').value.trim();
            if (!input) {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', confirmButtonColor: '#ff6b35', timer: 2000, timerProgressBar: true });
                return;
            }

            // Split by newlines to support multiple entries
            const schools = input.split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (schools.length === 0) {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', confirmButtonColor: '#ff6b35', timer: 2000, timerProgressBar: true });
                return;
            }

            try {
                let addedCount = 0;
                for (const school of schools) {
                    await window.addDoc(window.collection(window.db, 'schools'), { name: school });
                    addedCount++;
                }
                document.getElementById('newSchool').value = '';
                await loadSchools();
                await loadData(); // Update landing page
                Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${addedCount} ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô`, confirmButtonColor: '#ff6b35', timer: 1500, timerProgressBar: true, showConfirmButton: false });
            } catch (error) {
                console.error('Error adding school:', error);
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', confirmButtonColor: '#ff6b35' });
            }
        }

        async function deleteSchool(id) {
            const { isConfirmed } = await Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ?',
                showCancelButton: true,
                confirmButtonText: 'üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#aaa'
            });

            if (isConfirmed) {
                try {
                    await window.deleteDoc(window.doc(window.db, 'schools', id));
                    await loadSchools();
                    await loadData();
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏•‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#ff6b35', timer: 1500, timerProgressBar: true, showConfirmButton: false });
                } catch (error) {
                    console.error('Error deleting school:', error);
                }
            }
        }

        async function loadTeachers() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'teachers'));
                const teachers = [];
                querySnapshot.forEach((doc) => {
                    teachers.push({ id: doc.id, name: doc.data().name });
                });

                // Update teacher select
                const teacherSelect = document.getElementById('teacherSelect');
                teacherSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option>';
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.name;
                    option.textContent = teacher.name;
                    teacherSelect.appendChild(option);
                });

                // Update teacher list in settings
                const teacherList = document.getElementById('teacherList');
                teacherList.innerHTML = '';
                teachers.forEach(teacher => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span>${teacher.name}</span>
                        <button class="btn btn-danger btn-small" onclick="deleteTeacher('${teacher.id}')">‡∏•‡∏ö</button>
                    `;
                    teacherList.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading teachers:', error);
            }
        }

        async function addTeacher() {
            const input = document.getElementById('newTeacher').value.trim();
            if (!input) {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π', confirmButtonColor: '#ff6b35', timer: 2000, timerProgressBar: true });
                return;
            }

            // Split by newlines to support multiple entries
            const teachers = input.split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (teachers.length === 0) {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π', confirmButtonColor: '#ff6b35', timer: 2000, timerProgressBar: true });
                return;
            }

            try {
                let addedCount = 0;
                for (const teacher of teachers) {
                    await window.addDoc(window.collection(window.db, 'teachers'), { name: teacher });
                    addedCount++;
                }
                document.getElementById('newTeacher').value = '';
                loadTeachers();
                Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π ${addedCount} ‡∏ó‡πà‡∏≤‡∏ô`, confirmButtonColor: '#ff6b35', timer: 1500, timerProgressBar: true, showConfirmButton: false });
            } catch (error) {
                console.error('Error adding teacher:', error);
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π', confirmButtonColor: '#ff6b35' });
            }
        }

        async function deleteTeacher(id) {
            const { isConfirmed } = await Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?',
                showCancelButton: true,
                confirmButtonText: 'üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#aaa'
            });

            if (isConfirmed) {
                try {
                    await window.deleteDoc(window.doc(window.db, 'teachers', id));
                    loadTeachers();
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏•‡∏ö‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#ff6b35', timer: 1500, timerProgressBar: true, showConfirmButton: false });
                } catch (error) {
                    console.error('Error deleting teacher:', error);
                }
            }
        }

        async function saveSettings() {
            const academicHead = document.getElementById('academicHead').value;
            const deputyDirector = document.getElementById('deputyDirector').value;
            const director = document.getElementById('director').value;

            const settings = {
                academicHead,
                deputyDirector,
                director
            };

            try {
                // Try to update existing settings
                const querySnapshot = await window.getDocs(window.collection(window.db, 'settings'));
                if (querySnapshot.empty) {
                    await window.addDoc(window.collection(window.db, 'settings'), settings);
                } else {
                    const docRef = querySnapshot.docs[0].ref;
                    await window.updateDoc(docRef, settings);
                }
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        async function loadSettings() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'settings'));
                if (!querySnapshot.empty) {
                    const settings = querySnapshot.docs[0].data();
                    document.getElementById('academicHead').value = settings.academicHead || '';
                    document.getElementById('deputyDirector').value = settings.deputyDirector || '';
                    document.getElementById('director').value = settings.director || '';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function formatThaiDate(dateStr) {
            const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                          '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543;
            return `${day} ${month} ‡∏û.‡∏®. ${year}`;
        }

        async function generateMemoReport() {
            const querySnapshot = await window.getDocs(window.collection(window.db, 'registrations'));
            const data = [];
            querySnapshot.forEach((doc) => {
                data.push(doc.data());
            });

            const settingsSnapshot = await window.getDocs(window.collection(window.db, 'settings'));
            const settings = settingsSnapshot.empty ? {} : settingsSnapshot.docs[0].data();

            const academicHead = settings.academicHead || '(‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
            const deputyDirector = settings.deputyDirector || '(‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
            const director = settings.director || '(‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';

            const thaiDateStr = formatThaiDate(new Date().toISOString());

            // Calculate totals
            let totalStudents = 0;
            let totalMale = 0;
            let totalFemale = 0;
            let totalWritten = 0;
            let totalReceived = 0;

            const schoolSummary = {};

            data.forEach(item => {
                totalStudents += item.total || 0;
                totalMale += item.male || 0;
                totalFemale += item.female || 0;

                if (!schoolSummary[item.school]) {
                    schoolSummary[item.school] = {
                        total: 0,
                        male: 0,
                        female: 0,
                        written: 0,
                        received: 0,
                        teachers: new Set()
                    };
                }

                schoolSummary[item.school].total += item.total || 0;
                schoolSummary[item.school].male += item.male || 0;
                schoolSummary[item.school].female += item.female || 0;
                schoolSummary[item.school].teachers.add(item.teacher);

                if (item.students) {
                    item.students.forEach(student => {
                        if (student.hasWritten) {
                            totalWritten++;
                            schoolSummary[item.school].written++;
                        }
                        if (student.hasReceived) {
                            totalReceived++;
                            schoolSummary[item.school].received++;
                        }
                    });
                }
            });

            // Generate table rows
            let tableRows = '';
            let rowNumber = 1;
            Object.keys(schoolSummary).sort().forEach(school => {
                const summary = schoolSummary[school];
                const teacherNames = Array.from(summary.teachers).join(', ');
                
                tableRows += `
                    <tr>
                        <td>${rowNumber}</td>
                        <td class="text-left">${school}</td>
                        <td class="text-left">${teacherNames}</td>
                        <td>${summary.male}</td>
                        <td>${summary.female}</td>
                        <td><strong>${summary.total}</strong></td>
                        <td>${summary.written}</td>
                        <td>${summary.received}</td>
                    </tr>
                `;
                rowNumber++;
            });

            // Add total row
            tableRows += `
                <tr style="background: #fff5eb; font-weight: bold;">
                    <td colspan="3" style="text-align: center;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                    <td>${totalMale}</td>
                    <td>${totalFemale}</td>
                    <td>${totalStudents}</td>
                    <td>${totalWritten}</td>
                    <td>${totalReceived}</td>
                </tr>
            `;

            const memoHTML = `
                <div class="a4-paper memo-layout">
                    <div class="doc-header">
                        <img src="https://nonthaphathr.github.io/uploadimg/kruda.png" class="garuda" crossorigin="anonymous">
                        <div class="doc-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
                    </div>
                    
                    <div class="doc-meta">
                        <b>‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</b>&nbsp;&nbsp;‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏£‡∏°‡∏¢‡πå ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©
                    </div>
                    
                    <div class="doc-meta doc-meta-row">
                        <span class="doc-ref">
                            <b>‡∏ó‡∏µ‡πà</b>&nbsp;&nbsp;‡∏®‡∏Å 51008.08/............
                        </span>
                        <span class="doc-date">
                            <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</b>&nbsp;&nbsp;${thaiDateStr}
                        </span>
                    </div>
                    
                    <div class="doc-meta">
                        <b>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</b>&nbsp;&nbsp;‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </div>
                    
                    <hr class="doc-line">
                    
                    <div class="doc-to">
                        ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô&nbsp;&nbsp;‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
                    </div>
                    
                    <div class="doc-content">
                        ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${new Date().getFullYear() + 543} ‡∏ô‡∏±‡πâ‡∏ô
                    </div>
                    
                    <div class="doc-content">
                        ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ
                    </div>
                    
                    <table class="doc-table">
                        <colgroup>
                            <col style="width:5%">
                            <col style="width:25%">
                            <col style="width:20%">
                            <col style="width:8%">
                            <col style="width:8%">
                            <col style="width:8%">
                            <col style="width:13%">
                            <col style="width:13%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th rowspan="2">‡∏ó‡∏µ‡πà</th>
                                <th rowspan="2">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th rowspan="2">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                                <th colspan="3">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</th>
                                <th rowspan="2">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£<br>(‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß)</th>
                                <th rowspan="2">‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ<br>(‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)</th>
                            </tr>
                            <tr>
                                <th>‡∏ä‡∏≤‡∏¢</th>
                                <th>‡∏´‡∏ç‡∏¥‡∏á</th>
                                <th>‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="doc-closing">
                        ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö
                    </div>
                    
                    <table class="sign-table">
                        <tr>
                            <td>
                                ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß<br>
                                <span class="name-shift-left">(‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥)</span>
                            </td>
                            <td>
                                ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£<br>
                                <span class="name-shift-left">(${academicHead})</span>
                            </td>
                        </tr>
                        <tr style="height:12px;">
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>
                                <div class="checkbox-text">(&nbsp;&nbsp;&nbsp;) ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</div>
                                ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................<br>
                                (${deputyDirector})<br>
                                ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
                            </td>
                            <td>
                                <div class="checkbox-text">(&nbsp;&nbsp;&nbsp;) ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</div>
                                ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................<br>
                                (${director})<br>
                                ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
                            </td>
                        </tr>
                    </table>
                    
                    <div class="footer-system">
                        ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥
                    </div>
                </div>
            `;

            document.getElementById('memoContainer').innerHTML = memoHTML;
            scaleMemoForMobile();
            showToast('‡∏™‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }

        function scaleMemoForMobile() {
            const paper = document.querySelector('.a4-paper.memo-layout');
            if (!paper) return;

            const container = document.getElementById('memoContainer');
            if (!container) return;

            const viewportWidth = window.innerWidth;

            if (viewportWidth <= 768) {
                const paperWidth = 793.7; // 210mm in px
                const containerWidth = container.clientWidth;
                const scale = containerWidth / paperWidth;

                paper.style.transform = 'scale(' + scale + ')';
                paper.style.transformOrigin = 'top left';
                paper.style.width = paperWidth + 'px';
                paper.style.minHeight = 'auto';
                paper.style.margin = '0';
                paper.style.boxShadow = 'none';

                // ‡∏õ‡∏£‡∏±‡∏ö container height ‡πÉ‡∏´‡πâ match scaled content
                const paperHeight = paper.getBoundingClientRect().height;
                container.style.height = (paperHeight * scale) + 'px';
            } else {
                // desktop: reset
                paper.style.transform = '';
                paper.style.transformOrigin = '';
                paper.style.width = '';
                paper.style.minHeight = '';
                paper.style.margin = '';
                paper.style.boxShadow = '';
                container.style.height = '';
            }
        }

        window.addEventListener('resize', scaleMemoForMobile);

        function printMemo() {
            window.print();
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
