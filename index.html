<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</title>
    
    <!-- External Resources -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Kanit:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" crossorigin="anonymous">
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 
                   https://www.gstatic.com 
                   https://cdn.jsdelivr.net 
                   https://apis.google.com;
        style-src 'self' 'unsafe-inline' 
                  https://fonts.googleapis.com 
                  https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: https:;
        connect-src 'self' 
                    https://firestore.googleapis.com 
                    https://firebase.googleapis.com;
    ">
    
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #ff8c42;
            --bg-light: #fff5eb;
            --bg-lighter: #ffe0cc;
            --text-dark: #333;
            --text-light: #666;
            --text-muted: #999;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #007bff;
            --border-radius: 10px;
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 5px 20px rgba(0,0,0,0.1);
            --shadow-heavy: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-lighter) 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.05) 10px, rgba(255,255,255,0.05) 20px);
            animation: headerPattern 20s linear infinite;
        }
        @keyframes headerPattern {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .header-content { position: relative; z-index: 2; }
        .header img { width: 80px; height: 80px; margin-bottom: 15px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); }
        .header h1 { font-family: 'Kanit', sans-serif; font-size: 28px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 16px; opacity: 0.95; }

        /* Tabs */
        .tabs {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            padding: 10px; background: white; border-radius: 15px; box-shadow: var(--shadow-light);
        }
        .tab {
            padding: 12px 25px; background: transparent; border: 2px solid var(--bg-lighter);
            border-radius: var(--border-radius); cursor: pointer; font-family: 'Sarabun', sans-serif;
            font-size: 16px; font-weight: 600; color: var(--text-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;
        }
        .tab::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: left 0.3s ease; z-index: -1;
        }
        .tab:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); color: white; }
        .tab:hover::before { left: 0; }
        .tab.active { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; border-color: var(--primary-color); }
        .tab.active::before { left: 0; }

        /* Content Boxes */
        .content-box {
            display: none; background: white; padding: 30px; border-radius: 20px;
            box-shadow: var(--shadow-medium); position: relative; overflow: hidden;
        }
        .content-box::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .content-box.active { display: block; animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* School Grid */
        .school-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; }
        .school-card {
            background: linear-gradient(135deg, #fff 0%, var(--bg-light) 100%);
            padding: 30px 25px; border-radius: 15px; text-align: center; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid var(--bg-lighter);
            box-shadow: var(--shadow-light); position: relative; overflow: hidden;
        }
        .school-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            opacity: 0; transition: opacity 0.3s ease;
        }
        .school-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 40px rgba(255, 107, 53, 0.3); border-color: var(--primary-color); }
        .school-card:hover::before { opacity: 0.05; }
        .school-card-content { position: relative; z-index: 2; }
        .school-card h3 { color: var(--primary-color); font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .school-card .count { font-size: 36px; font-weight: 700; color: var(--text-dark); margin: 15px 0; }
        .school-card .label { color: var(--text-muted); font-size: 14px; }

        /* Form Styles */
        .form-section { margin-bottom: 30px; padding: 25px; background: var(--bg-light); border-radius: 15px; border-left: 4px solid var(--primary-color); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-dark); font-weight: 600; font-size: 16px; }
        .form-group .label-required::after { content: ' *'; color: var(--danger-color); }
        .form-group select, .form-group input, .form-group textarea {
            width: 100%; padding: 12px 15px; border: 2px solid var(--bg-lighter);
            border-radius: var(--border-radius); font-size: 16px; font-family: 'Sarabun', sans-serif;
            transition: all 0.3s ease; background: white;
        }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        /* Student Section */
        .student-section {
            background: linear-gradient(135deg, #fff 0%, var(--bg-light) 100%);
            padding: 30px; border-radius: 20px; margin: 30px 0;
            border: 2px solid var(--bg-lighter); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.1);
            position: relative; overflow: hidden;
        }
        .student-section::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .student-section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--bg-lighter);
        }
        .student-section-header h3 { color: var(--primary-color); font-family: 'Kanit', sans-serif; font-size: 22px; margin: 0; display: flex; align-items: center; gap: 10px; }
        .student-list { display: flex; flex-direction: column; gap: 20px; }
        .student-item {
            background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--bg-lighter);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .student-item:hover { border-color: var(--primary-color); box-shadow: 0 8px 30px rgba(255, 107, 53, 0.15); transform: translateY(-3px); }
        .student-item::before {
            content: attr(data-student-number); position: absolute; top: -12px; left: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white; padding: 6px 15px; border-radius: 25px; font-size: 13px; font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        .student-name-row { display: grid; grid-template-columns: 150px 1fr 1fr; gap: 20px; align-items: center; margin-bottom: 20px; }
        .student-name-row select, .student-name-row input {
            padding: 12px 16px; border: 2px solid var(--bg-lighter); border-radius: 12px;
            font-size: 16px; font-family: 'Sarabun', sans-serif; transition: all 0.3s ease;
            background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .student-name-row select:focus, .student-name-row input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1), 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-1px);
        }
        .student-name-row select { cursor: pointer; background: linear-gradient(135deg, #fff 0%, var(--bg-light) 100%); font-weight: 600; color: var(--primary-color); }
        .student-bottom-row { display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid var(--bg-lighter); }
        .checkbox-group { display: flex; gap: 25px; flex-wrap: wrap; align-items: center; }
        .checkbox-group label {
            display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 500;
            color: var(--text-dark); transition: all 0.3s ease; padding: 8px 12px; border-radius: 8px;
            background: var(--bg-light); border: 1px solid transparent;
        }
        .checkbox-group label:hover { color: var(--primary-color); background: white; border-color: var(--primary-color); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 107, 53, 0.1); }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color); border-radius: 4px; }
        .student-item .btn-danger { padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2); }
        .student-item .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3); }
        .student-list:empty::after {
            content: 'üë• ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≤‡∏¢/‡∏´‡∏ç‡∏¥‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô';
            display: block; text-align: center; padding: 40px 20px; color: var(--text-muted);
            font-style: italic; background: var(--bg-light); border: 2px dashed var(--bg-lighter); border-radius: 12px; font-size: 16px;
        }

        /* Number Inputs */
        .number-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 15px; }
        .number-input-group { background: white; padding: 15px; border-radius: var(--border-radius); text-align: center; border: 2px solid var(--bg-lighter); transition: all 0.3s ease; }
        .number-input-group:hover { border-color: var(--primary-color); box-shadow: var(--shadow-light); }
        .number-input-group label { font-size: 14px; color: var(--text-light); margin-bottom: 8px; display: block; }
        .number-input-group input { font-size: 18px; font-weight: 700; text-align: center; color: var(--primary-color); border: none; background: transparent; width: 100%; padding: 5px; }
        .number-input-group input[readonly] { color: var(--success-color); background: var(--bg-light); border-radius: 5px; }

        /* Buttons */
        .btn {
            padding: 12px 30px; border: none; border-radius: var(--border-radius); font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: 'Sarabun', sans-serif;
            position: relative; overflow: hidden; text-decoration: none; display: inline-block; text-align: center;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
        .btn-secondary { background: white; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .btn-secondary:hover:not(:disabled) { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40,167,69,0.4); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-excel { background: linear-gradient(135deg, #1d6f42 0%, #217346 100%); color: white; box-shadow: 0 4px 15px rgba(29,111,66,0.3); }
        .btn-excel:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(29,111,66,0.4); }
        .btn-small { padding: 8px 20px; font-size: 14px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #fff 0%, var(--bg-light) 100%); padding: 25px 20px; border-radius: 15px; text-align: center; border: 2px solid var(--bg-lighter); box-shadow: var(--shadow-light); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(255, 107, 53, 0.2); }
        .stat-card h3 { color: var(--text-light); font-size: 14px; margin-bottom: 12px; font-weight: 600; }
        .stat-card .value { font-size: 42px; font-weight: 700; color: var(--primary-color); margin-bottom: 8px; }
        .stat-card .label { color: var(--text-muted); font-size: 14px; }

        /* Chart Container */
        .chart-container { background: white; padding: 25px; border-radius: 15px; box-shadow: var(--shadow-light); margin: 20px 0; }
        .chart-wrapper { position: relative; height: 400px; }

        /* Percentage Display */
        .percentage-display { background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow-light); text-align: center; margin: 20px 0; }
        .percentage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center; }
        .percentage-item h4 { font-size: 18px; color: var(--text-light); margin-bottom: 10px; }
        .percentage-item .big-number { font-size: 48px; font-weight: 700; margin: 10px 0; }
        .percentage-item .unit { font-size: 16px; color: var(--text-muted); }
        .percentage-badge { position: absolute; top: 0; right: 0; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 12px 24px; border-radius: 50px; font-size: 28px; font-weight: 700; box-shadow: var(--shadow-heavy); }

        /* Table Styles */
        .detail-table-wrapper { overflow-x: auto; border-radius: 15px; box-shadow: var(--shadow-medium); margin-top: 20px; background: white; }
        .detail-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; font-size: 14px; }
        .detail-table thead tr th { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; font-weight: 600; padding: 15px 12px; text-align: center; white-space: nowrap; border: none; }
        .detail-table tbody tr td { padding: 12px; text-align: center; border-bottom: 1px solid var(--bg-lighter); }
        .detail-table tbody tr:hover { background: var(--bg-light); }

        /* Settings */
        .settings-section { margin-bottom: 35px; padding: 25px; background: white; border-radius: 15px; box-shadow: var(--shadow-light); border-left: 4px solid var(--primary-color); }
        .settings-section h3 { color: var(--primary-color); margin-bottom: 15px; font-family: 'Kanit', sans-serif; }
        .settings-help { color: var(--text-light); font-size: 14px; margin-bottom: 15px; padding: 10px 15px; background: var(--bg-light); border-radius: 8px; border-left: 3px solid var(--warning-color); }
        .settings-list { display: flex; flex-direction: column; gap: 10px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--bg-lighter); transition: all 0.3s ease; }
        .list-item:hover { background: white; border-color: var(--primary-color); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; align-items: center; justify-content: center; }
        .modal.show { display: flex !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: white; padding: 0; border-radius: 20px; width: 90%; max-width: 700px; max-height: 85vh; box-shadow: 0 20px 60px rgba(0,0,0,0.4); position: relative; animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; margin: 0; transform: translate(0, 0); }
        @keyframes modalSlideUp { from { transform: translateY(50px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .modal-header h3 { margin: 0; font-size: 22px; font-weight: 600; font-family: 'Kanit', sans-serif; }
        .modal-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease; line-height: 1; }
        .modal-close:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .modal-body { padding: 30px; max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid var(--bg-lighter); display: flex; gap: 15px; justify-content: flex-end; background: #f9f9f9; position: sticky; bottom: 0; }
        .report-text { background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px solid #dee2e6; font-family: 'Sarabun', sans-serif; line-height: 1.8; white-space: pre-wrap; font-size: 15px; color: var(--text-dark); max-height: 500px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* Loading */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .loading-content { background: white; padding: 40px; border-radius: 20px; text-align: center; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid var(--bg-lighter); border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }

        /* Report / A4 */
        #report.content-box { border-radius: 0; box-shadow: none; background: #f5f5f5; padding: 20px; }
        #memoContainer { background: transparent; border-radius: 0 !important; box-shadow: none !important; }
        #memoContainer *, #memoContainer *::before, #memoContainer *::after { border-radius: 0 !important; box-shadow: none !important; }

        .a4-paper { width: 210mm; min-height: 297mm; background: white; padding: 10mm 15mm 10mm 20mm; font-family: 'Sarabun', sans-serif; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 20px auto; position: relative; }

        .memo-layout { font-family: 'Sarabun', sans-serif !important; position: relative; min-height: 297mm; padding: 10mm 15mm 25mm 20mm; border-radius: 0 !important; box-shadow: none !important; }
        .memo-layout *, .memo-layout *::before, .memo-layout *::after { border-radius: 0 !important; box-shadow: none !important; }
        .memo-layout .garuda { position: absolute; left: 22mm; top: 9.3mm; width: 1.3cm; height: auto; }
        .memo-layout .doc-title { text-align: center; font-size: 20pt; font-weight: bold; padding-top: 5mm; margin-bottom: 2mm; }
        .memo-layout .doc-meta { font-size: 11pt; line-height: 1.4; margin-bottom: 1px; white-space: nowrap; }
        .memo-layout .doc-meta-row { display: flex; justify-content: flex-start; gap: 0; }
        .memo-layout .doc-meta-row .doc-ref { flex: 0 0 50%; }
        .memo-layout .doc-meta-row .doc-date { flex: 0 0 50%; text-align: left; padding-left: 10px; }
        .memo-layout .doc-line { border: none; border-bottom: 1px solid black; margin: 2px 0 8px 0; }
        .memo-layout .doc-to { font-size: 11pt; font-weight: bold; font-style: italic; margin-bottom: 2px; line-height: 1.4; }
        .memo-layout .doc-content { font-size: 11pt; text-indent: 2.5cm; text-align: justify; line-height: 1.5; margin-bottom: 2px; }
        .memo-layout .doc-closing { font-size: 11pt; text-indent: 2.5cm; margin-top: 8px; margin-bottom: 15px; line-height: 1.4; }
        .memo-layout .doc-table { width: 100%; border-collapse: collapse; margin: 4px 0; font-size: 10pt; border-radius: 0 !important; box-shadow: none !important; outline: none !important; }
        .memo-layout .doc-table th, .memo-layout .doc-table td { border: 1px solid black; padding: 2px 3px; text-align: center; vertical-align: middle; line-height: 1.2; font-size: 10pt; border-radius: 0 !important; box-shadow: none !important; }
        .memo-layout .doc-table th { background: white; font-weight: bold; font-size: 10pt; color: black; }
        .memo-layout .doc-table td.text-left { text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .memo-layout .sign-table { width: 100%; border-collapse: collapse; border: none !important; margin-top: 12px; border-radius: 0 !important; box-shadow: none !important; outline: none !important; }
        .memo-layout .sign-table td { border: none !important; vertical-align: top; text-align: center; padding: 2px 5px; width: 50%; font-size: 11pt; line-height: 1.3; white-space: nowrap; border-radius: 0 !important; box-shadow: none !important; }
        .memo-layout .name-shift-left { display: inline-block; position: relative; left: -10mm; }
        .memo-layout .checkbox-text { text-align: left; padding-left: 15px; margin-bottom: 1px; font-size: 11pt; }
        .memo-layout .footer-system { position: absolute; bottom: 10mm; left: 0; width: 100%; text-align: center; font-size: 10pt; color: #666; font-style: italic; }

        /* Page 2 - Student Detail */
        .memo-page2 { font-family: 'Sarabun', sans-serif !important; position: relative; min-height: 297mm; padding: 10mm 15mm 25mm 20mm; border-radius: 0 !important; box-shadow: none !important; page-break-before: always; }
        .memo-page2 *, .memo-page2 *::before, .memo-page2 *::after { border-radius: 0 !important; box-shadow: none !important; }
        .memo-page2 .page2-title { text-align: center; font-size: 14pt; font-weight: bold; margin-bottom: 4mm; padding-top: 5mm; }
        .memo-page2 .page2-subtitle { text-align: center; font-size: 11pt; margin-bottom: 6mm; color: #444; }
        .memo-page2 .school-block { margin-bottom: 6mm; }
        .memo-page2 .school-name { font-size: 11pt; font-weight: bold; background: #fff5eb; padding: 2px 6px; border-left: 3px solid #ff6b35; margin-bottom: 2mm; display: block; }
        .memo-page2 .student-table { width: 100%; border-collapse: collapse; font-size: 9.5pt; margin-bottom: 2mm; }
        .memo-page2 .student-table th { background: #ff6b35; color: white; font-weight: bold; padding: 3px 5px; border: 1px solid #cc5028; text-align: center; font-size: 9.5pt; }
        .memo-page2 .student-table td { border: 1px solid #ccc; padding: 2px 5px; vertical-align: middle; font-size: 9.5pt; }
        .memo-page2 .student-table td.text-left { text-align: left; }
        .memo-page2 .student-table tr:nth-child(even) { background: #fff5eb; }
        .memo-page2 .footer-system { position: absolute; bottom: 10mm; left: 0; width: 100%; text-align: center; font-size: 9pt; color: #666; font-style: italic; }

        /* Toast */
        .toast { position: fixed; top: 20px; right: 20px; background: var(--success-color); color: white; padding: 15px 25px; border-radius: var(--border-radius); box-shadow: var(--shadow-heavy); z-index: 1100; animation: toastSlideIn 0.3s ease; }
        .toast.error { background: var(--danger-color); }
        .toast.warning { background: var(--warning-color); color: var(--text-dark); }
        @keyframes toastSlideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { to { transform: translateX(400px); opacity: 0; } }

        /* Utilities */
        .text-center { text-align: center; }
        .hidden { display: none !important; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }

        /* Mobile Responsive */
        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 20px 15px; }
            .header h1 { font-size: 22px; }
            .tabs { overflow-x: auto; flex-wrap: nowrap; padding: 5px; }
            .tab { flex-shrink: 0; padding: 10px 15px; font-size: 14px; white-space: nowrap; }
            .content-box { padding: 20px 15px; }
            .school-grid { grid-template-columns: 1fr; }
            .number-inputs { grid-template-columns: 1fr; gap: 15px; }
            .student-name-row { grid-template-columns: 1fr 1fr; gap: 10px; }
            .student-name-row select { grid-column: 1 / -1; }
            .checkbox-group { gap: 15px; flex-direction: column; }
            .percentage-grid { grid-template-columns: 1fr; gap: 20px; }
            .percentage-badge { position: static; margin-top: 15px; display: inline-block; }
            .btn-group { flex-direction: column; }
            .btn-group .btn { width: 100%; margin: 0; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .detail-table-wrapper { display: none; }
            .mobile-cards { display: block; }
        }

        @media screen and (min-width: 769px) {
            .mobile-cards { display: none; }
            .mobile-actions { display: none; }
        }

        @media screen and (max-width: 480px) {
            .header { padding: 15px 10px; }
            .header h1 { font-size: 20px; }
            .content-box { padding: 15px 10px; }
            .btn { padding: 10px 20px; font-size: 14px; width: 100%; margin-bottom: 10px; }
            .stats-grid { grid-template-columns: 1fr; gap: 10px; }
        }

        /* Mobile Cards */
        .mobile-card { background: white; margin-bottom: 15px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 4px solid var(--primary-color); position: relative; }
        .mobile-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--bg-lighter); }
        .mobile-card-header h4 { color: var(--primary-color); font-size: 16px; font-weight: 600; margin: 0; flex: 1; line-height: 1.3; }
        .mobile-card-actions { display: flex; gap: 8px; flex-shrink: 0; margin-left: 10px; }
        .mobile-card-actions .btn { padding: 6px 12px; font-size: 12px; border-radius: 6px; min-width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; }
        .mobile-card-body { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .mobile-card-item { text-align: center; }
        .mobile-card-item .label { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; display: block; }
        .mobile-card-item .value { font-size: 18px; font-weight: 600; color: var(--text-dark); display: block; }
        .mobile-card-item .value.total { color: var(--primary-color); font-size: 20px; }
        .mobile-card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--text-muted); padding-top: 10px; border-top: 1px solid var(--bg-lighter); }
        .mobile-actions { display: flex; gap: 10px; margin-top: 20px; }
        .mobile-actions .btn { flex: 1; padding: 15px; font-size: 15px; border-radius: 12px; text-align: center; font-weight: 600; }

        /* Print Styles */
        @media print {
            @page { size: A4 portrait; margin: 8mm 10mm 8mm 15mm; }
            body { background: white !important; padding: 0 !important; }
            * { visibility: hidden; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .a4-paper, .a4-paper *, .memo-layout, .memo-layout *, .memo-page2, .memo-page2 * { visibility: visible !important; }
            .a4-paper { position: static !important; margin: 0 !important; padding: 0 !important; width: 100% !important; min-height: auto !important; box-shadow: none !important; border: none !important; background: white !important; }
            .memo-layout { position: static !important; width: 100% !important; height: auto !important; min-height: auto !important; padding: 0 !important; margin: 0 !important; }
            .memo-page2 { position: static !important; width: 100% !important; height: auto !important; min-height: auto !important; padding: 0 !important; margin: 0 !important; page-break-before: always; }
            .memo-layout .garuda { position: absolute !important; left: 2mm !important; top: -1mm !important; width: 13mm !important; }
            .memo-layout .doc-title { font-size: 18pt !important; padding-top: 8mm !important; }
            .memo-layout .doc-table th, .memo-layout .doc-table td { border: 1px solid black !important; padding: 1.5mm 1mm !important; font-size: 9pt !important; }
            .memo-layout .sign-table td { border: none !important; font-size: 11pt !important; }
            .memo-layout .footer-system { position: relative !important; bottom: auto !important; margin-top: 10mm !important; font-size: 9pt !important; }
            .memo-page2 .student-table th { background: #ff6b35 !important; color: white !important; }
            .memo-page2 .student-table tr:nth-child(even) { background: #fff5eb !important; }
            .memo-page2 .school-name { background: #fff5eb !important; }
            .memo-page2 .footer-system { position: relative !important; bottom: auto !important; margin-top: 10mm !important; }
            .header, .tabs, nav, .btn, button, .modal, .toast, .loading-overlay { display: none !important; }
            #report .text-center, #report h2, #report .btn-group { display: none !important; }
        }

        @media screen and (max-width: 768px) {
            #report.content-box { padding: 10px; }
            .a4-paper { width: 100%; max-width: 100%; padding: 5mm 8mm; min-height: auto; }
            .memo-layout { padding: 5mm 8mm; font-size: 9pt; }
            .memo-layout .doc-title { font-size: 16pt; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" alt="‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤" crossorigin="anonymous">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <p>‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥<br>‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
            <div style="margin-top: 15px; font-size: 14px; opacity: 0.8;">
                üîí ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ v2.1 | üõ°Ô∏è Security Enhanced | üì• Excel Export
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <nav class="tabs">
        <button class="tab active" onclick="showTab('landing')">üè´ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
        <button class="tab" onclick="showTab('submit')">üìù ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button class="tab" onclick="showTab('stats')">üìä ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
        <button class="tab" onclick="showTab('report')">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        <button class="tab" onclick="showSettingsTab()" style="font-size: 20px;">‚öôÔ∏è</button>
    </nav>

    <!-- Landing Page -->
    <div id="landing" class="content-box active">
        <h2 style="color: var(--primary-color); margin-bottom: 25px; font-family: 'Kanit', sans-serif;">
            üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß
        </h2>
        <div class="school-grid" id="schoolGrid">
            <div class="school-card">
                <div class="school-card-content">
                    <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h3>
                    <div class="count"><div class="loading"></div></div>
                    <div class="label">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Form -->
    <div id="submit" class="content-box">
        <h2 style="color: var(--primary-color); margin-bottom: 25px; font-family: 'Kanit', sans-serif;">
            üìù ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </h2>
        <form id="studentForm" novalidate>
            <div class="form-section">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
                <div class="form-group">
                    <label for="schoolSelect" class="label-required">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <select id="schoolSelect" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option></select>
                </div>
                <div class="form-group">
                    <label for="teacherSelect" class="label-required">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                    <select id="teacherSelect" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option></select>
                </div>
                <div class="form-group">
                    <label for="totalStudentsInSchool">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏õ.6 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°.3) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="number" id="totalStudentsInSchool" min="0" max="999" value="0" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                </div>
            </div>
            <div class="form-section">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                    üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                    <span style="font-size: 13px; font-weight: 400; color: #fff; background: var(--primary-color); padding: 3px 10px; border-radius: 20px; margin-left: 10px;">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®</span>
                </h3>
                <div class="number-inputs">
                    <div class="number-input-group">
                        <label>üë¶ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏≤‡∏¢</label>
                        <input type="number" id="maleCount" min="0" max="999" value="0" oninput="handleNumberInput(this); generateStudentForms();">
                    </div>
                    <div class="number-input-group">
                        <label>üëß ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏ç‡∏¥‡∏á</label>
                        <input type="number" id="femaleCount" min="0" max="999" value="0" oninput="handleNumberInput(this); generateStudentForms();">
                    </div>
                    <div class="number-input-group">
                        <label>üë• ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <input type="number" id="totalCount" readonly>
                    </div>
                </div>
            </div>
            <div class="student-section">
                <div class="student-section-header">
                    <h3 style="color: var(--primary-color);">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addStudent()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </div>
                <div id="studentList" class="student-list"></div>
            </div>
            <div class="text-center mt-20">
                <button type="submit" class="btn btn-primary" id="saveButton">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()" style="margin-left: 10px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            </div>
        </form>
    </div>

    <!-- Statistics -->
    <div id="stats" class="content-box">
        <h2 style="color: var(--primary-color); margin-bottom: 25px; font-family: 'Kanit', sans-serif;">
            üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </h2>
        <div style="margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div>
                <label for="filterSchool" style="margin-bottom: 8px; font-weight: 600;">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                <select id="filterSchool" onchange="filterStatistics()" style="padding: 10px 15px; border: 2px solid var(--bg-lighter); border-radius: var(--border-radius); font-size: 16px;">
                    <option value="all">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
            </div>
            <div style="margin-top: auto;">
                <button class="btn btn-excel" onclick="exportToExcel()">üì• Export Excel</button>
            </div>
        </div>
        <div class="stats-grid" id="statsGrid"></div>
        <div class="chart-container">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">üéØ ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <div id="percentageDisplay" class="percentage-display"></div>
        </div>
        <div class="chart-container">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">üìà ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <div class="chart-wrapper"><canvas id="schoolChart"></canvas></div>
        </div>
        <h3 style="color: var(--primary-color); margin-bottom: 15px;">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div class="detail-table-wrapper">
            <table id="detailTable" class="detail-table">
                <thead>
                    <tr>
                        <th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th><th>‡∏ô‡∏£.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                        <th>‡∏ä‡∏≤‡∏¢</th><th>‡∏´‡∏ç‡∏¥‡∏á</th><th>‡∏£‡∏ß‡∏°</th>
                        <th>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th><th>‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                        <th>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="detailTableBody"></tbody>
            </table>
        </div>
        <div class="btn-group mt-20">
            <button class="btn btn-success" onclick="copyReportText()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå</button>
            <button class="btn btn-excel" onclick="exportToExcel()">üì• Export Excel ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>

    <!-- Report -->
    <div id="report" class="content-box">
        <h2 style="color: var(--primary-color); margin-bottom: 25px;">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
        <div class="btn-group mb-20">
            <button class="btn btn-primary" onclick="generateMemoReport()">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
            <button class="btn btn-secondary" onclick="printMemo()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            <button class="btn btn-excel" onclick="exportToExcel()">üì• Export Excel ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>
        <div id="memoContainer"></div>
    </div>

    <!-- Settings -->
    <div id="settings" class="content-box">
        <h2 style="color: var(--primary-color); margin-bottom: 25px;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <div class="settings-section">
            <h3>üè´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <p class="settings-help">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ</p>
            <div class="form-group">
                <textarea id="newSchool" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" rows="3" style="width:100%;padding:12px;border:2px solid var(--bg-lighter);border-radius:var(--border-radius);font-size:16px;font-family:'Sarabun',sans-serif;resize:vertical;"></textarea>
            </div>
            <button class="btn btn-secondary btn-small" onclick="addSchool()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <div id="schoolList" class="settings-list mt-20"></div>
        </div>
        <div class="settings-section">
            <h3>üë®‚Äçüè´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π</h3>
            <p class="settings-help">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ</p>
            <div class="form-group">
                <textarea id="newTeacher" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Ñ‡∏£‡∏π" rows="3" style="width:100%;padding:12px;border:2px solid var(--bg-lighter);border-radius:var(--border-radius);font-size:16px;font-family:'Sarabun',sans-serif;resize:vertical;"></textarea>
            </div>
            <button class="btn btn-secondary btn-small" onclick="addTeacher()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</button>
            <div id="teacherList" class="settings-list mt-20"></div>
        </div>
        <div class="settings-section">
            <h3>üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤</h3>
            <div class="form-group">
                <label for="academicHead">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</label>
                <input type="text" id="academicHead" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="form-group">
                <label for="deputyDirector">‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <input type="text" id="deputyDirector" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="form-group">
                <label for="director">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <input type="text" id="director" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
    </div>

    <!-- Modal for Report -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå</h3>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalReportText" class="report-text"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReportModal()">‡∏õ‡∏¥‡∏î</button>
                <button class="btn btn-success" onclick="copyFromModal()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        </div>
    </div>
</div>

<!-- Firebase Integration (Secure) -->
<script type="module">
    const ALLOWED_DOMAINS = ['localhost', '127.0.0.1', 'nonthaphathr.github.io', 'your-domain.com'];
    const currentDomain = window.location.hostname;
    const isValidDomain = ALLOWED_DOMAINS.some(domain => currentDomain === domain || currentDomain.endsWith(domain));
    if (!isValidDomain && window.location.protocol === 'https:') {
        document.body.innerHTML = '<div style="text-align:center;padding:50px;"><h1>üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</h1><p>‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</p></div>';
    }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCW0myweqSL3hEtCPTfzzsEeyO1lnzk-sI",
        authDomain: "nanaewktw.firebaseapp.com",
        projectId: "nanaewktw",
        storageBucket: "nanaewktw.firebasestorage.app",
        messagingSenderId: "1028815149041",
        appId: "1:1028815149041:web:11429d3b7addcb78f9d650"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    class RateLimiter {
        constructor() { this.requests = new Map(); this.windowMs = 60000; this.maxRequests = 30; }
        checkLimit(key = 'global') {
            const now = Date.now(), windowStart = now - this.windowMs;
            if (!this.requests.has(key)) this.requests.set(key, []);
            const requests = this.requests.get(key);
            const validRequests = requests.filter(t => t > windowStart);
            this.requests.set(key, validRequests);
            if (validRequests.length >= this.maxRequests) return false;
            validRequests.push(now); return true;
        }
    }
    const rateLimiter = new RateLimiter();

    class SecurityValidator {
        static sanitizeString(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/javascript:/gi, '').replace(/on\w+\s*=\s*["'][^"']*["']/gi, '')
                .trim().substring(0, 255);
        }
        static validateThaiName(name) { return /^[a-zA-Z‡∏Å-‡∏Æ\s.-]+$/.test(name) && name.length > 0 && name.length <= 100; }
        static validateNumber(num, min = 0, max = 999) { const n = parseInt(num); return !isNaN(n) && n >= min && n <= max; }
    }

    class SecureFirebaseAPI {
        constructor() { this.maxRetries = 3; this.retryDelay = 1000; }
        async executeWithRetry(operation, retries = 0) {
            try {
                if (!rateLimiter.checkLimit()) throw new Error('Rate limit exceeded. Please wait.');
                return await operation();
            } catch (error) {
                if (retries < this.maxRetries && ['unavailable','deadline-exceeded','resource-exhausted'].includes(error.code)) {
                    await new Promise(r => setTimeout(r, this.retryDelay * Math.pow(2, retries)));
                    return this.executeWithRetry(operation, retries + 1);
                }
                throw error;
            }
        }
        validateAndSanitizeRegistration(data) {
            const errors = [];
            if (!data.school || data.school.length < 2) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
            if (!data.teacher || data.teacher.length < 2) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            if (!SecurityValidator.validateNumber(data.male)) errors.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            if (!SecurityValidator.validateNumber(data.female)) errors.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            if (errors.length > 0) throw new Error(errors.join(', '));
            const sanitized = {
                school: SecurityValidator.sanitizeString(data.school),
                teacher: SecurityValidator.sanitizeString(data.teacher),
                male: parseInt(data.male) || 0, female: parseInt(data.female) || 0,
                total: parseInt(data.total) || 0, totalStudentsInSchool: parseInt(data.totalStudentsInSchool) || 0,
                date: new Date().toLocaleDateString('th-TH'), timestamp: new Date().toISOString(), students: []
            };
            if (data.students && Array.isArray(data.students)) {
                sanitized.students = data.students.map(s => ({
                    prefix: SecurityValidator.sanitizeString(s.prefix),
                    firstName: SecurityValidator.sanitizeString(s.firstName),
                    lastName: SecurityValidator.sanitizeString(s.lastName),
                    hasWritten: Boolean(s.hasWritten), hasReceived: Boolean(s.hasReceived)
                })).filter(s => s.firstName.length > 0 && s.lastName.length > 0);
            }
            return sanitized;
        }
        async saveRegistration(data) { return this.executeWithRetry(async () => { const s = this.validateAndSanitizeRegistration(data); const d = await addDoc(collection(db, 'registrations'), s); return { success: true, id: d.id }; }); }
        async getRegistrations() { return this.executeWithRetry(async () => { const q = query(collection(db, 'registrations'), orderBy('timestamp', 'desc')); const snap = await getDocs(q); return snap.docs.map(d => ({ id: d.id, ...d.data() })); }); }
        async updateRegistration(id, data) { return this.executeWithRetry(async () => { if (!id || id.length < 10) throw new Error('Invalid ID'); const s = this.validateAndSanitizeRegistration(data); s.updatedAt = new Date().toISOString(); await updateDoc(doc(db, 'registrations', id), s); return { success: true }; }); }
        async deleteRegistration(id) { return this.executeWithRetry(async () => { if (!id || id.length < 10) throw new Error('Invalid ID'); await deleteDoc(doc(db, 'registrations', id)); return { success: true }; }); }
        async getSchools() { return this.executeWithRetry(async () => { const q = query(collection(db, 'schools'), orderBy('name')); const snap = await getDocs(q); return snap.docs.map(d => ({ id: d.id, name: SecurityValidator.sanitizeString(d.data().name) })); }); }
        async saveSchool(name) { return this.executeWithRetry(async () => { const n = SecurityValidator.sanitizeString(name); if (!SecurityValidator.validateThaiName(n)) throw new Error('‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); const d = await addDoc(collection(db, 'schools'), { name: n, createdAt: new Date().toISOString() }); return { success: true, id: d.id }; }); }
        async deleteSchool(id) { return this.executeWithRetry(async () => { await deleteDoc(doc(db, 'schools', id)); return { success: true }; }); }
        async getTeachers() { return this.executeWithRetry(async () => { const q = query(collection(db, 'teachers'), orderBy('name')); const snap = await getDocs(q); return snap.docs.map(d => ({ id: d.id, name: SecurityValidator.sanitizeString(d.data().name) })); }); }
        async saveTeacher(name) { return this.executeWithRetry(async () => { const n = SecurityValidator.sanitizeString(name); if (!SecurityValidator.validateThaiName(n)) throw new Error('‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); const d = await addDoc(collection(db, 'teachers'), { name: n, createdAt: new Date().toISOString() }); return { success: true, id: d.id }; }); }
        async deleteTeacher(id) { return this.executeWithRetry(async () => { await deleteDoc(doc(db, 'teachers', id)); return { success: true }; }); }
        async getSettings() { return this.executeWithRetry(async () => { const snap = await getDocs(collection(db, 'settings')); if (snap.empty) return {}; const s = snap.docs[0].data(); return { academicHead: SecurityValidator.sanitizeString(s.academicHead || ''), deputyDirector: SecurityValidator.sanitizeString(s.deputyDirector || ''), director: SecurityValidator.sanitizeString(s.director || '') }; }); }
        async saveSettings(settings) { return this.executeWithRetry(async () => { const s = { academicHead: SecurityValidator.sanitizeString(settings.academicHead || ''), deputyDirector: SecurityValidator.sanitizeString(settings.deputyDirector || ''), director: SecurityValidator.sanitizeString(settings.director || ''), updatedAt: new Date().toISOString() }; const snap = await getDocs(collection(db, 'settings')); if (snap.empty) await addDoc(collection(db, 'settings'), s); else await updateDoc(snap.docs[0].ref, s); return { success: true }; }); }
    }

    window.secureFirebaseAPI = new SecureFirebaseAPI();
    console.log('üîí Secure Firebase API v2.1 initialized');
</script>

<!-- Main Application Script -->
<script>
    let studentCounter = 0, currentEditingId = null, allRegistrationData = [];
    const CONFIG = { PASSWORD: 'ktw2024secure', MAX_STUDENTS: 50 };

    function showToast(message, type = 'success') {
        const t = document.createElement('div');
        t.className = `toast ${type}`; t.textContent = message;
        document.body.appendChild(t);
        setTimeout(() => { t.style.animation = 'toastSlideOut 0.3s ease forwards'; setTimeout(() => t.remove(), 300); }, 3000);
    }
    function showLoadingOverlay() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
    function hideLoadingOverlay() { document.getElementById('loadingOverlay').classList.add('hidden'); }

    function showTab(tabName) {
        document.querySelectorAll('.content-box').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelectorAll('.tab').forEach(tab => {
            const text = tab.textContent.trim();
            if ((tabName === 'landing' && text.includes('‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô')) ||
                (tabName === 'submit' && text.includes('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) ||
                (tabName === 'stats' && text.includes('‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥')) ||
                (tabName === 'report' && text.includes('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'))) tab.classList.add('active');
        });
        if (tabName === 'submit') initializeSubmitForm();
        else if (tabName === 'stats') loadData();
        else if (tabName === 'landing') loadLandingPage();
    }

    async function showSettingsTab() {
        const result = await Swal.fire({ title: 'üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', input: 'password', inputAttributes: { autocomplete: 'current-password', placeholder: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' }, showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤', confirmButtonColor: 'var(--primary-color)', cancelButtonColor: '#aaa' });
        if (result.isDismissed) return;
        if (result.value === CONFIG.PASSWORD) { showTab('settings'); await loadSettings(); }
        else await Swal.fire({ icon: 'error', title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', confirmButtonColor: 'var(--primary-color)', timer: 2000, timerProgressBar: true });
    }

    function handleNumberInput(input) { if (parseInt(input.value) < 0) input.value = 0; if (parseInt(input.value) > 999) input.value = 999; updateTotal(); }
    function updateTotal() { const m = parseInt(document.getElementById('maleCount').value) || 0, f = parseInt(document.getElementById('femaleCount').value) || 0; document.getElementById('totalCount').value = m + f; }

    function generateStudentForms() {
        const male = parseInt(document.getElementById('maleCount').value) || 0;
        const female = parseInt(document.getElementById('femaleCount').value) || 0;
        const total = male + female;
        if (total > CONFIG.MAX_STUDENTS) { showToast(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏ô ${CONFIG.MAX_STUDENTS} ‡∏Ñ‡∏ô`, 'warning'); return; }
        if (total === 0) { document.getElementById('studentList').innerHTML = ''; studentCounter = 0; return; }
        const existingData = [];
        document.querySelectorAll('.student-item').forEach(item => {
            existingData.push({ prefix: item.querySelector('select').value, firstName: item.querySelectorAll('input[type="text"]')[0].value, lastName: item.querySelectorAll('input[type="text"]')[1].value, hasWritten: item.querySelector('.checkbox-written').checked, hasReceived: item.querySelector('.checkbox-received').checked });
        });
        const prefixes = [...Array(male).fill('‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'), ...Array(female).fill('‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á')];
        document.getElementById('studentList').innerHTML = ''; studentCounter = 0;
        prefixes.forEach((p, i) => createStudentItem(p, existingData[i]));
    }

    function createStudentItem(defaultPrefix = '‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢', existingData = null) {
        studentCounter++;
        const div = document.createElement('div');
        div.className = 'student-item'; div.id = `student-${studentCounter}`; div.setAttribute('data-student-number', `‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${studentCounter}`);
        const prefix = existingData ? existingData.prefix : defaultPrefix;
        const firstName = existingData ? existingData.firstName : '';
        const lastName = existingData ? existingData.lastName : '';
        const hasWritten = existingData ? existingData.hasWritten : false;
        const hasReceived = existingData ? existingData.hasReceived : false;
        div.innerHTML = `
            <div class="student-name-row">
                <select>
                    <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢" ${prefix==='‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'?'selected':''}>‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                    <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á" ${prefix==='‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á'?'selected':''}>‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                    <option value="‡∏ô‡∏≤‡∏¢" ${prefix==='‡∏ô‡∏≤‡∏¢'?'selected':''}>‡∏ô‡∏≤‡∏¢</option>
                    <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" ${prefix==='‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß'?'selected':''}>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                </select>
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${firstName}" maxlength="50">
                <input type="text" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value="${lastName}" maxlength="50">
            </div>
            <div class="student-bottom-row">
                <div class="checkbox-group">
                    <label><input type="checkbox" class="checkbox-written" ${hasWritten?'checked':''}> ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</label>
                    <label><input type="checkbox" class="checkbox-received" ${hasReceived?'checked':''}> ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</label>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeStudent(${studentCounter})">üóëÔ∏è ‡∏•‡∏ö</button>
            </div>`;
        document.getElementById('studentList').appendChild(div);
    }

    function addStudent() { if (studentCounter >= CONFIG.MAX_STUDENTS) { showToast(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô ${CONFIG.MAX_STUDENTS} ‡∏Ñ‡∏ô`, 'warning'); return; } createStudentItem(); }
    function removeStudent(id) { const el = document.getElementById(`student-${id}`); if (el) el.remove(); }

    function resetForm() {
        if (currentEditingId) { currentEditingId = null; showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß'); }
        document.getElementById('studentForm').reset();
        ['maleCount','femaleCount','totalCount','totalStudentsInSchool'].forEach(id => document.getElementById(id).value = 0);
        document.getElementById('studentList').innerHTML = ''; studentCounter = 0; addStudent();
    }
    function initializeSubmitForm() { if (document.getElementById('studentList').children.length === 0) addStudent(); }

    async function saveData() {
        const btn = document.getElementById('saveButton'), orig = btn.innerHTML;
        try {
            btn.disabled = true; btn.innerHTML = '<div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            const school = document.getElementById('schoolSelect').value;
            const teacher = document.getElementById('teacherSelect').value;
            const male = parseInt(document.getElementById('maleCount').value) || 0;
            const female = parseInt(document.getElementById('femaleCount').value) || 0;
            if (!school || !teacher) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            const students = [];
            document.querySelectorAll('.student-item').forEach(item => {
                const fn = item.querySelectorAll('input[type="text"]')[0].value.trim();
                const ln = item.querySelectorAll('input[type="text"]')[1].value.trim();
                if (fn && ln) students.push({ prefix: item.querySelector('select').value, firstName: fn, lastName: ln, hasWritten: item.querySelector('.checkbox-written').checked, hasReceived: item.querySelector('.checkbox-received').checked });
            });
            const data = { school, teacher, male, female, total: male + female, totalStudentsInSchool: parseInt(document.getElementById('totalStudentsInSchool').value) || 0, students };
            if (currentEditingId) { await window.secureFirebaseAPI.updateRegistration(currentEditingId, data); showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); currentEditingId = null; }
            else { await window.secureFirebaseAPI.saveRegistration(data); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); }
            resetForm(); await loadData(); showTab('stats');
        } catch (error) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error'); }
        finally { btn.disabled = false; btn.innerHTML = orig; }
    }

    async function loadData() {
        try {
            allRegistrationData = await window.secureFirebaseAPI.getRegistrations();
            updateStatistics(allRegistrationData); updateDetailTable(allRegistrationData);
        } catch (error) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error'); }
    }

    async function loadSchools() {
        try {
            const schools = await window.secureFirebaseAPI.getSchools();
            const schoolSelect = document.getElementById('schoolSelect');
            schoolSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>';
            schools.forEach(s => { const o = document.createElement('option'); o.value = s.name; o.textContent = s.name; schoolSelect.appendChild(o); });
            const filterSchool = document.getElementById('filterSchool');
            const cur = filterSchool.value;
            filterSchool.innerHTML = '<option value="all">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            schools.forEach(s => { const o = document.createElement('option'); o.value = s.name; o.textContent = s.name; filterSchool.appendChild(o); });
            filterSchool.value = cur;
            updateSchoolList(schools);
            const counts = {};
            if (allRegistrationData) allRegistrationData.forEach(item => { counts[item.school] = (counts[item.school] || 0) + (item.total || 0); });
            updateSchoolGrid(schools, counts);
        } catch (error) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error'); }
    }

    async function addSchool() {
        const input = document.getElementById('newSchool').value.trim();
        if (!input) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning'); return; }
        try {
            const schools = input.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            for (const s of schools) await window.secureFirebaseAPI.saveSchool(s);
            document.getElementById('newSchool').value = '';
            await loadSchools(); await loadData();
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${schools.length} ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        } catch (error) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error'); }
    }

    async function deleteSchool(id) {
        const r = await Swal.fire({ icon: 'warning', title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ?', showCancelButton: true, confirmButtonText: 'üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡∏¢', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: '#dc3545' });
        if (r.isConfirmed) { try { await window.secureFirebaseAPI.deleteSchool(id); await loadSchools(); await loadData(); showToast('‡∏•‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error'); } }
    }

    async function loadTeachers() {
        try {
            const teachers = await window.secureFirebaseAPI.getTeachers();
            const sel = document.getElementById('teacherSelect');
            sel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option>';
            teachers.forEach(t => { const o = document.createElement('option'); o.value = t.name; o.textContent = t.name; sel.appendChild(o); });
            updateTeacherList(teachers);
        } catch (error) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π', 'error'); }
    }

    async function addTeacher() {
        const input = document.getElementById('newTeacher').value.trim();
        if (!input) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π', 'warning'); return; }
        try {
            const ts = input.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            for (const t of ts) await window.secureFirebaseAPI.saveTeacher(t);
            document.getElementById('newTeacher').value = ''; await loadTeachers();
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π ${ts.length} ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        } catch (error) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error'); }
    }

    async function deleteTeacher(id) {
        const r = await Swal.fire({ icon: 'warning', title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?', showCancelButton: true, confirmButtonText: 'üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡∏¢', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: '#dc3545' });
        if (r.isConfirmed) { try { await window.secureFirebaseAPI.deleteTeacher(id); await loadTeachers(); showToast('‡∏•‡∏ö‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error'); } }
    }

    async function loadSettings() {
        try { const s = await window.secureFirebaseAPI.getSettings(); document.getElementById('academicHead').value = s.academicHead || ''; document.getElementById('deputyDirector').value = s.deputyDirector || ''; document.getElementById('director').value = s.director || ''; }
        catch (e) { console.error('Load settings error:', e); }
    }

    async function saveSettings() {
        try { await window.secureFirebaseAPI.saveSettings({ academicHead: document.getElementById('academicHead').value, deputyDirector: document.getElementById('deputyDirector').value, director: document.getElementById('director').value }); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); }
        catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error'); }
    }

    function updateSchoolList(schools) {
        const list = document.getElementById('schoolList'); if (!list) return;
        list.innerHTML = '';
        schools.forEach(s => { const d = document.createElement('div'); d.className = 'list-item'; d.innerHTML = `<span>${s.name}</span><button class="btn btn-danger btn-small" onclick="deleteSchool('${s.id}')">‡∏•‡∏ö</button>`; list.appendChild(d); });
    }

    function updateTeacherList(teachers) {
        const list = document.getElementById('teacherList'); if (!list) return;
        list.innerHTML = '';
        teachers.forEach(t => { const d = document.createElement('div'); d.className = 'list-item'; d.innerHTML = `<span>${t.name}</span><button class="btn btn-danger btn-small" onclick="deleteTeacher('${t.id}')">‡∏•‡∏ö</button>`; list.appendChild(d); });
    }

    function updateSchoolGrid(schools, schoolCounts = null) {
        const grid = document.getElementById('schoolGrid'); if (!grid) return;
        if (!schoolCounts) { schoolCounts = {}; if (allRegistrationData) allRegistrationData.forEach(i => { schoolCounts[i.school] = (schoolCounts[i.school] || 0) + (i.total || 0); }); }
        grid.innerHTML = '';
        schools.forEach(s => { const c = schoolCounts[s.name] || 0; const card = document.createElement('div'); card.className = 'school-card'; card.onclick = () => selectSchool(s.name); card.innerHTML = `<div class="school-card-content"><h3>${s.name}</h3><div class="count">${c}</div><div class="label">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div></div>`; grid.appendChild(card); });
    }

    function selectSchool(school) { document.getElementById('schoolSelect').value = school; showTab('submit'); initializeSubmitForm(); }

    function updateStatistics(data) {
        let totalStudents = 0, totalMale = 0, totalFemale = 0, totalWritten = 0, totalReceived = 0, totalStudentsInAllSchools = 0;
        const schoolCounts = {};
        data.forEach(item => {
            totalStudents += item.total || 0; totalMale += item.male || 0; totalFemale += item.female || 0; totalStudentsInAllSchools += item.totalStudentsInSchool || 0;
            if (item.students) item.students.forEach(s => { if (s.hasWritten) totalWritten++; if (s.hasReceived) totalReceived++; });
            schoolCounts[item.school] = (schoolCounts[item.school] || 0) + (item.total || 0);
        });
        const pct = totalStudentsInAllSchools > 0 ? ((totalStudents / totalStudentsInAllSchools) * 100).toFixed(2) : 0;
        const sg = document.getElementById('statsGrid');
        if (sg) sg.innerHTML = `
            <div class="stat-card"><h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><div class="value">${totalStudentsInAllSchools}</div><div class="label">‡∏Ñ‡∏ô</div></div>
            <div class="stat-card"><h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3><div class="value">${totalStudents}</div><div class="label">‡∏Ñ‡∏ô</div></div>
            <div class="stat-card"><h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏≤‡∏¢</h3><div class="value">${totalMale}</div><div class="label">‡∏Ñ‡∏ô</div></div>
            <div class="stat-card"><h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏ç‡∏¥‡∏á</h3><div class="value">${totalFemale}</div><div class="label">‡∏Ñ‡∏ô</div></div>
            <div class="stat-card"><h3>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3><div class="value">${totalWritten}</div><div class="label">‡∏Ñ‡∏ô</div></div>
            <div class="stat-card"><h3>‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ</h3><div class="value">${totalReceived}</div><div class="label">‡∏Ñ‡∏ô</div></div>`;
        const pd = document.getElementById('percentageDisplay');
        if (pd) pd.innerHTML = `<div class="percentage-grid"><div class="percentage-item"><h4>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4><div class="big-number" style="color:var(--text-dark);">${totalStudentsInAllSchools}</div><div class="unit">‡∏Ñ‡∏ô</div></div><div class="percentage-item" style="position:relative;"><h4>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h4><div class="big-number" style="color:var(--primary-color);">${totalStudents}</div><div class="unit">‡∏Ñ‡∏ô</div><div class="percentage-badge">${pct}%</div></div></div>`;
        updateChart(schoolCounts);
        updateLandingPageSchoolGrid(schoolCounts);
    }

    async function updateLandingPageSchoolGrid(schoolCounts) {
        try { const schools = await window.secureFirebaseAPI.getSchools(); updateSchoolGrid(schools, schoolCounts); }
        catch (e) { console.error(e); }
    }

    function updateChart(schoolCounts) {
        const ctx = document.getElementById('schoolChart'); if (!ctx) return;
        if (window.schoolChartInstance) window.schoolChartInstance.destroy();
        const schools = Object.keys(schoolCounts).sort(), counts = schools.map(s => schoolCounts[s]);
        if (schools.length === 0) return;
        try {
            window.schoolChartInstance = new Chart(ctx, { type: 'bar', data: { labels: schools, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£', data: counts, backgroundColor: 'rgba(255, 107, 53, 0.7)', borderColor: 'rgba(255, 107, 53, 1)', borderWidth: 2, borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: true, position: 'top', labels: { font: { family: 'Sarabun', size: 14 } } }, tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { family: 'Sarabun', size: 14 }, bodyFont: { family: 'Sarabun', size: 13 }, padding: 12, cornerRadius: 8 } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, font: { family: 'Sarabun', size: 12 } }, grid: { color: 'rgba(255,107,53,0.1)' } }, x: { ticks: { font: { family: 'Sarabun', size: 12 }, maxRotation: 45, minRotation: 0 }, grid: { display: false } } } } });
        } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü', 'error'); }
    }

    function updateDetailTable(data) {
        const tbody = document.getElementById('detailTableBody');
        if (tbody) {
            tbody.innerHTML = '';
            data.forEach(item => {
                const written = item.students ? item.students.filter(s => s.hasWritten).length : 0;
                const received = item.students ? item.students.filter(s => s.hasReceived).length : 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.school}</td><td>${item.teacher}</td><td>${item.totalStudentsInSchool||0}</td><td>${item.male||0}</td><td>${item.female||0}</td><td><strong>${item.total||0}</strong></td><td>${written}</td><td>${received}</td><td>${item.date}</td><td><button class="btn btn-success btn-small" onclick="copySchoolReport('${item.id}')">üìã</button></td><td><button onclick="editRecord('${item.id}')" class="btn btn-secondary btn-small" style="margin-right:5px;">‚úèÔ∏è</button><button onclick="deleteRecord('${item.id}')" class="btn btn-danger btn-small">üóëÔ∏è</button></td>`;
                tbody.appendChild(tr);
            });
        }
        updateMobileCards(data);
    }

    function updateMobileCards(data) {
        const existing = document.querySelector('.mobile-cards'); if (existing) existing.remove();
        const container = document.createElement('div'); container.className = 'mobile-cards';
        data.forEach(item => {
            const written = item.students ? item.students.filter(s => s.hasWritten).length : 0;
            const received = item.students ? item.students.filter(s => s.hasReceived).length : 0;
            const card = document.createElement('div'); card.className = 'mobile-card';
            card.innerHTML = `<div class="mobile-card-header"><h4>${item.school}</h4><div class="mobile-card-actions"><button class="btn btn-success btn-small" onclick="copySchoolReport('${item.id}')">üìã</button><button class="btn btn-secondary btn-small" onclick="editRecord('${item.id}')">‚úèÔ∏è</button><button class="btn btn-danger btn-small" onclick="deleteRecord('${item.id}')">üóëÔ∏è</button></div></div><div class="mobile-card-body"><div class="mobile-card-item"><span class="label">‡∏ô‡∏£.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span class="value">${item.totalStudentsInSchool||0}</span></div><div class="mobile-card-item"><span class="label">‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span><span class="value total">${item.total||0}</span></div><div class="mobile-card-item"><span class="label">‡∏ä‡∏≤‡∏¢</span><span class="value">${item.male||0}</span></div><div class="mobile-card-item"><span class="label">‡∏´‡∏ç‡∏¥‡∏á</span><span class="value">${item.female||0}</span></div><div class="mobile-card-item"><span class="label">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span><span class="value">${written}</span></div><div class="mobile-card-item"><span class="label">‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ</span><span class="value">${received}</span></div></div><div class="mobile-card-meta"><span>‡∏Ñ‡∏£‡∏π: ${item.teacher}</span><span>${item.date}</span></div>`;
            container.appendChild(card);
        });
        const mobileActions = document.createElement('div'); mobileActions.className = 'mobile-actions';
        mobileActions.innerHTML = `<button class="btn btn-success" onclick="copyReportText()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå</button><button class="btn btn-excel" onclick="exportToExcel()">üì• Export Excel</button>`;
        container.appendChild(mobileActions);
        const chartContainer = document.querySelector('.chart-container');
        if (chartContainer) chartContainer.parentNode.insertBefore(container, chartContainer.nextSibling);
    }

    function filterStatistics() {
        const sel = document.getElementById('filterSchool').value;
        const filtered = sel === 'all' ? allRegistrationData : allRegistrationData.filter(i => i.school === sel);
        updateStatistics(filtered); updateDetailTable(filtered);
    }

    async function deleteRecord(id) {
        const r = await Swal.fire({ icon: 'warning', title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ', showCancelButton: true, confirmButtonText: 'üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡∏¢', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: '#dc3545' });
        if (r.isConfirmed) { try { await window.secureFirebaseAPI.deleteRegistration(id); showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); await loadData(); } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error'); } }
    }

    async function editRecord(id) {
        const record = allRegistrationData.find(i => i.id === id);
        if (!record) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error'); return; }
        currentEditingId = id;
        document.getElementById('schoolSelect').value = record.school;
        document.getElementById('teacherSelect').value = record.teacher;
        document.getElementById('totalStudentsInSchool').value = record.totalStudentsInSchool || 0;
        document.getElementById('maleCount').value = record.male || 0;
        document.getElementById('femaleCount').value = record.female || 0;
        updateTotal();
        document.getElementById('studentList').innerHTML = ''; studentCounter = 0;
        if (record.students && record.students.length > 0) record.students.forEach(s => createStudentItem(s.prefix, s));
        else addStudent();
        showTab('submit'); showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
    }

    // ====== NEW: Export to Excel ======
    function exportToExcel() {
        const data = allRegistrationData || [];
        if (data.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export', 'warning'); return; }

        const wb = XLSX.utils.book_new();

        // ---- Sheet 1: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ----
        const summaryRows = [
            ['‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤'],
            [`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}`],
            [],
            ['‡∏ó‡∏µ‡πà', '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏ô‡∏£.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á', '‡∏£‡∏ß‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£', '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å']
        ];
        let totalMaleSum = 0, totalFemaleSum = 0, totalSum = 0, totalWrittenSum = 0, totalReceivedSum = 0;
        data.forEach((item, idx) => {
            const written = item.students ? item.students.filter(s => s.hasWritten).length : 0;
            const received = item.students ? item.students.filter(s => s.hasReceived).length : 0;
            totalMaleSum += item.male || 0; totalFemaleSum += item.female || 0; totalSum += item.total || 0; totalWrittenSum += written; totalReceivedSum += received;
            summaryRows.push([idx + 1, item.school, item.teacher, item.totalStudentsInSchool || 0, item.male || 0, item.female || 0, item.total || 0, written, received, item.date]);
        });
        summaryRows.push(['', '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '', '', totalMaleSum, totalFemaleSum, totalSum, totalWrittenSum, totalReceivedSum, '']);

        const ws1 = XLSX.utils.aoa_to_sheet(summaryRows);
        ws1['!cols'] = [{ wch: 5 }, { wch: 28 }, { wch: 22 }, { wch: 18 }, { wch: 8 }, { wch: 8 }, { wch: 14 }, { wch: 16 }, { wch: 16 }, { wch: 14 }];
        ws1['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 9 } }, { s: { r: 1, c: 0 }, e: { r: 1, c: 9 } }];
        XLSX.utils.book_append_sheet(wb, ws1, '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');

        // ---- Sheet 2: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ----
        const studentRows = [
            ['‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤'],
            [`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}`],
            [],
            ['‡∏ó‡∏µ‡πà', '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ']
        ];
        let rowNum = 1;
        data.forEach(item => {
            if (item.students && item.students.length > 0) {
                item.students.forEach(s => {
                    studentRows.push([rowNum++, item.school, item.teacher, s.prefix, s.firstName, s.lastName, s.hasWritten ? '‚úì' : '', s.hasReceived ? '‚úì' : '']);
                });
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÉ‡∏™‡πà‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á
                const totalNo = item.total || 0;
                for (let i = 0; i < totalNo; i++) {
                    studentRows.push([rowNum++, item.school, item.teacher, '', '', '', '', '']);
                }
            }
        });

        const ws2 = XLSX.utils.aoa_to_sheet(studentRows);
        ws2['!cols'] = [{ wch: 5 }, { wch: 28 }, { wch: 22 }, { wch: 10 }, { wch: 16 }, { wch: 18 }, { wch: 16 }, { wch: 16 }];
        ws2['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 7 } }, { s: { r: 1, c: 0 }, e: { r: 1, c: 7 } }];
        XLSX.utils.book_append_sheet(wb, ws2, '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');

        // ---- ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Sheet ‡πÅ‡∏¢‡∏Å ----
        const schoolGroups = {};
        data.forEach(item => { if (!schoolGroups[item.school]) schoolGroups[item.school] = []; schoolGroups[item.school].push(item); });
        Object.keys(schoolGroups).sort().forEach(school => {
            const items = schoolGroups[school];
            const sheetRows = [
                [`‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ${school}`],
                [`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}`],
                [],
                ['‡∏ó‡∏µ‡πà', '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ']
            ];
            let n = 1;
            items.forEach(item => {
                if (item.students && item.students.length > 0) {
                    item.students.forEach(s => sheetRows.push([n++, s.prefix, s.firstName, s.lastName, item.teacher, s.hasWritten ? '‚úì' : '', s.hasReceived ? '‚úì' : '']));
                }
            });
            const wsSchool = XLSX.utils.aoa_to_sheet(sheetRows);
            wsSchool['!cols'] = [{ wch: 5 }, { wch: 10 }, { wch: 16 }, { wch: 18 }, { wch: 22 }, { wch: 16 }, { wch: 16 }];
            wsSchool['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }, { s: { r: 1, c: 0 }, e: { r: 1, c: 6 } }];
            // ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠ sheet ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 31 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
            const sheetName = school.substring(0, 28).replace(/[\\/*?[\]:]/g, '_');
            XLSX.utils.book_append_sheet(wb, wsSchool, sheetName);
        });

        const fileName = `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showToast('Export Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üì•');
    }

    // ====== Report functions ======
    async function copyReportText() {
        try {
            const data = allRegistrationData || [];
            if (data.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'warning'); return; }
            let totalStudents = 0, totalMale = 0, totalFemale = 0, totalWritten = 0, totalReceived = 0;
            const schoolData = {};
            data.forEach(item => {
                totalStudents += item.total || 0; totalMale += item.male || 0; totalFemale += item.female || 0;
                if (!schoolData[item.school]) schoolData[item.school] = { total: 0, male: 0, female: 0, written: 0, received: 0 };
                schoolData[item.school].total += item.total || 0; schoolData[item.school].male += item.male || 0; schoolData[item.school].female += item.female || 0;
                if (item.students) item.students.forEach(s => { if (s.hasWritten) { totalWritten++; schoolData[item.school].written++; } if (s.hasReceived) { totalReceived++; schoolData[item.school].received++; } });
            });
            let reportText = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}\n\n‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°\n‚Ä¢ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏±‡∏ö‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${totalStudents} ‡∏Ñ‡∏ô\n‚Ä¢ ‡∏ä‡∏≤‡∏¢: ${totalMale} ‡∏Ñ‡∏ô\n‚Ä¢ ‡∏´‡∏ç‡∏¥‡∏á: ${totalFemale} ‡∏Ñ‡∏ô\n‚Ä¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß: ${totalWritten} ‡∏Ñ‡∏ô\n‚Ä¢ ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á: ${totalReceived} ‡∏Ñ‡∏ô\n\nüìç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n`;
            Object.keys(schoolData).sort().forEach(school => { const sd = schoolData[school]; reportText += `\n${school}\n‚Ä¢ ‡∏£‡∏ß‡∏° ${sd.total} ‡∏Ñ‡∏ô (‡∏ä‡∏≤‡∏¢ ${sd.male} ‡∏´‡∏ç‡∏¥‡∏á ${sd.female})\n‚Ä¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ${sd.written} ‡∏Ñ‡∏ô, ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ${sd.received} ‡∏Ñ‡∏ô\n`; });
            reportText += `\nüìù ‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤`;
            document.getElementById('modalReportText').textContent = reportText;
            const modal = document.getElementById('reportModal'); modal.classList.add('show'); modal.style.display = 'flex';
            window.currentReportText = reportText;
        } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + e.message, 'error'); }
    }

    async function copySchoolReport(id) {
        try {
            const record = allRegistrationData.find(i => i.id === id);
            if (!record) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ', 'error'); return; }
            const written = record.students ? record.students.filter(s => s.hasWritten).length : 0;
            const received = record.students ? record.students.filter(s => s.hasReceived).length : 0;
            let reportText = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}\n\nüè´ ${record.school}\nüë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${record.teacher}\n\n‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n‚Ä¢ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${record.totalStudentsInSchool || 0} ‡∏Ñ‡∏ô\n‚Ä¢ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${record.total || 0} ‡∏Ñ‡∏ô\n  - ‡∏ä‡∏≤‡∏¢: ${record.male || 0} ‡∏Ñ‡∏ô\n  - ‡∏´‡∏ç‡∏¥‡∏á: ${record.female || 0} ‡∏Ñ‡∏ô\n‚Ä¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß: ${written} ‡∏Ñ‡∏ô\n‚Ä¢ ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á: ${received} ‡∏Ñ‡∏ô`;
            if (record.students && record.students.length > 0) {
                reportText += `\n\nüìù ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${record.students.length} ‡∏Ñ‡∏ô)`;
                record.students.forEach((s, i) => { const status = []; if (s.hasWritten) status.push('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß'); if (s.hasReceived) status.push('‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á'); reportText += `\n${i + 1}. ${s.prefix}${s.firstName} ${s.lastName}${status.length > 0 ? ` (${status.join(', ')})` : ''}`; });
            }
            reportText += `\n\nüìù ‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤`;
            document.getElementById('modalReportText').textContent = reportText;
            const modal = document.getElementById('reportModal'); modal.classList.add('show'); modal.style.display = 'flex';
            window.currentReportText = reportText;
        } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + e.message, 'error'); }
    }

    async function generateMemoReport() {
        try {
            const data = allRegistrationData || [];
            if (data.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'warning'); return; }
            const settings = await window.secureFirebaseAPI.getSettings();
            const academicHead = settings.academicHead || '(‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
            const deputyDirector = settings.deputyDirector || '(‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
            const director = settings.director || '(‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
            const thaiDateStr = formatThaiDate(new Date().toISOString());
            let totalStudents = 0, totalMale = 0, totalFemale = 0, totalWritten = 0, totalReceived = 0;
            const schoolSummary = {};
            data.forEach(item => {
                totalStudents += item.total || 0; totalMale += item.male || 0; totalFemale += item.female || 0;
                if (!schoolSummary[item.school]) schoolSummary[item.school] = { total: 0, male: 0, female: 0, written: 0, received: 0, teachers: new Set() };
                schoolSummary[item.school].total += item.total || 0; schoolSummary[item.school].male += item.male || 0; schoolSummary[item.school].female += item.female || 0;
                schoolSummary[item.school].teachers.add(item.teacher);
                if (item.students) item.students.forEach(s => { if (s.hasWritten) { totalWritten++; schoolSummary[item.school].written++; } if (s.hasReceived) { totalReceived++; schoolSummary[item.school].received++; } });
            });

            let tableRows = '', rowNumber = 1;
            Object.keys(schoolSummary).sort().forEach(school => {
                const summary = schoolSummary[school];
                const teacherNames = Array.from(summary.teachers).join(', ');
                tableRows += `<tr><td>${rowNumber}</td><td class="text-left">${school}</td><td class="text-left">${teacherNames}</td><td>${summary.male}</td><td>${summary.female}</td><td><strong>${summary.total}</strong></td><td>${summary.written}</td><td>${summary.received}</td></tr>`;
                rowNumber++;
            });
            tableRows += `<tr style="background:#fff5eb;font-weight:bold;"><td colspan="3" style="text-align:center;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td>${totalMale}</td><td>${totalFemale}</td><td>${totalStudents}</td><td>${totalWritten}</td><td>${totalReceived}</td></tr>`;

            // ==== Page 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô ====
            let page2Content = '';
            const schoolGroups = {};
            data.forEach(item => { if (!schoolGroups[item.school]) schoolGroups[item.school] = []; schoolGroups[item.school].push(item); });
            Object.keys(schoolGroups).sort().forEach(school => {
                const items = schoolGroups[school];
                // ‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å record ‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ
                const allStudents = [];
                items.forEach(item => { if (item.students) item.students.forEach((s, idx) => allStudents.push({ ...s, teacher: item.teacher, seq: allStudents.length + 1 })); });
                if (allStudents.length === 0) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠

                let studentRows2 = '';
                allStudents.forEach((s, idx) => {
                    const status = [];
                    if (s.hasWritten) status.push('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß');
                    if (s.hasReceived) status.push('‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ');
                    studentRows2 += `<tr><td>${idx + 1}</td><td class="text-left">${s.prefix}${s.firstName} ${s.lastName}</td><td>${s.hasWritten ? '‚úì' : ''}</td><td>${s.hasReceived ? '‚úì' : ''}</td><td class="text-left">${s.teacher}</td></tr>`;
                });

                page2Content += `
                    <div class="school-block">
                        <span class="school-name">üè´ ${school} (${allStudents.length} ‡∏Ñ‡∏ô)</span>
                        <table class="student-table">
                            <thead>
                                <tr><th>‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th><th>‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ</th><th>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th></tr>
                            </thead>
                            <tbody>${studentRows2}</tbody>
                        </table>
                    </div>`;
            });

            const memoHTML = `
                <div class="a4-paper memo-layout">
                    <img src="https://nonthaphathr.github.io/uploadimg/kruda.png" class="garuda" crossorigin="anonymous">
                    <div class="doc-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
                    <div class="doc-meta"><b>‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</b>&nbsp;&nbsp;‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏£‡∏°‡∏¢‡πå ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©</div>
                    <div class="doc-meta doc-meta-row"><span class="doc-ref"><b>‡∏ó‡∏µ‡πà</b>&nbsp;&nbsp;‡∏®‡∏Å 51008.08/............</span><span class="doc-date"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</b>&nbsp;&nbsp;${thaiDateStr}</span></div>
                    <div class="doc-meta"><b>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</b>&nbsp;&nbsp;‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                    <hr class="doc-line">
                    <div class="doc-to">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô&nbsp;&nbsp;‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
                    <div class="doc-content">‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${new Date().getFullYear() + 543} ‡∏ô‡∏±‡πâ‡∏ô</div>
                    <div class="doc-content">‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ</div>
                    <table class="doc-table">
                        <colgroup><col style="width:5%"><col style="width:25%"><col style="width:20%"><col style="width:8%"><col style="width:8%"><col style="width:8%"><col style="width:13%"><col style="width:13%"></colgroup>
                        <thead><tr><th rowspan="2">‡∏ó‡∏µ‡πà</th><th rowspan="2">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th rowspan="2">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th><th colspan="3">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</th><th rowspan="2">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£<br>(‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß)</th><th rowspan="2">‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ<br>(‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)</th></tr><tr><th>‡∏ä‡∏≤‡∏¢</th><th>‡∏´‡∏ç‡∏¥‡∏á</th><th>‡∏£‡∏ß‡∏°</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    <div class="doc-closing">‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö</div>
                    <table class="sign-table">
                        <tr>
                            <td>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß<br><span class="name-shift-left">(‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥)</span></td>
                            <td>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£<br><span class="name-shift-left">(${academicHead})</span></td>
                        </tr>
                        <tr style="height:12px;"><td></td><td></td></tr>
                        <tr>
                            <td><div class="checkbox-text">(&nbsp;&nbsp;&nbsp;) ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</div>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................<br>(${deputyDirector})<br>‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</td>
                            <td><div class="checkbox-text">(&nbsp;&nbsp;&nbsp;) ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</div>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠........................................<br>(${director})<br>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</td>
                        </tr>
                    </table>
                    <div class="footer-system">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥</div>
                </div>

                ${page2Content ? `
                <div class="a4-paper memo-page2">
                    <div class="page2-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                    <div class="page2-subtitle">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${thaiDateStr}</div>
                    ${page2Content}
                    <div class="footer-system">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥</div>
                </div>` : ''}
            `;

            document.getElementById('memoContainer').innerHTML = memoHTML;
            scaleMemoForMobile();
            showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (2 ‡∏´‡∏ô‡πâ‡∏≤)');
        } catch (e) { console.error(e); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ' + e.message, 'error'); }
    }

    function scaleMemoForMobile() {
        const papers = document.querySelectorAll('.a4-paper');
        const container = document.getElementById('memoContainer');
        if (!container || papers.length === 0) return;
        const viewportWidth = window.innerWidth;
        if (viewportWidth <= 768) {
            const paperWidth = 793.7;
            const containerWidth = container.clientWidth;
            const scale = containerWidth / paperWidth;
            papers.forEach(paper => { paper.style.transform = `scale(${scale})`; paper.style.transformOrigin = 'top left'; paper.style.width = paperWidth + 'px'; paper.style.minHeight = 'auto'; paper.style.margin = '0'; });
        } else {
            papers.forEach(paper => { paper.style.transform = ''; paper.style.transformOrigin = ''; paper.style.width = ''; paper.style.minHeight = ''; paper.style.margin = ''; });
        }
    }
    window.addEventListener('resize', scaleMemoForMobile);

    function formatThaiDate(dateStr) {
        const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
        const d = new Date(dateStr);
        return `${d.getDate()} ${months[d.getMonth()]} ‡∏û.‡∏®. ${d.getFullYear() + 543}`;
    }

    function printMemo() { window.print(); }

    function closeReportModal() {
        const modal = document.getElementById('reportModal');
        modal.classList.remove('show');
        setTimeout(() => { modal.style.display = 'none'; }, 300);
    }

    window.onclick = e => { const modal = document.getElementById('reportModal'); if (e.target === modal) closeReportModal(); };
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { const modal = document.getElementById('reportModal'); if (modal.classList.contains('show')) closeReportModal(); } });

    function copyFromModal() {
        const reportText = window.currentReportText || document.getElementById('modalReportText').textContent;
        if (!reportText) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 'warning'); return; }
        navigator.clipboard.writeText(reportText).then(() => { showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); closeReportModal(); }).catch(() => {
            const ta = document.createElement('textarea'); ta.value = reportText; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); closeReportModal(); } catch { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'error'); }
            document.body.removeChild(ta);
        });
    }

    function loadLandingPage() { loadData().then(() => loadSchools()).catch(() => loadSchools()); }

    async function initializeApp() {
        try {
            showLoadingOverlay();
            await Promise.all([loadTeachers(), loadSettings()]);
            await loadData();
            await loadSchools();
            addStudent();
            hideLoadingOverlay();
            showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        } catch (e) { hideLoadingOverlay(); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ' + e.message, 'error'); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => { if (window.secureFirebaseAPI) initializeApp(); else showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°', 'error'); }, 1000);
        document.getElementById('studentForm').addEventListener('submit', async e => { e.preventDefault(); await saveData(); });
    });

    console.log('üéâ Secure Student Registration System v2.1 Loaded');
    console.log('‚ú® New: Excel Export | Page 2 Student Detail');
</script>
</body>
</html>
